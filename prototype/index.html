<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#6C63FF">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Family Hub">
  <meta name="description" content="ê°€ì¡± ê³µë™ê´€ë¦¬ ì•± - ì¼ì •, ì§‘ì•ˆì¼, ë²Œê¸ˆ, íˆ¬í‘œ ê´€ë¦¬">

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- App Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">

  <title>Family Hub - ê°€ì¡± ê³µë™ê´€ë¦¬</title>
  <script>
    // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬
    window.onerror = function (msg, src, line, col, err) {
      var d = document.getElementById('_dbg');
      if (!d) {
        d = document.createElement('div');
        d.id = '_dbg';
        d.style.cssText = 'position:fixed;bottom:0;left:0;right:0;max-height:30vh;overflow:auto;background:#1a0000;color:#ff6b6b;font:11px monospace;padding:8px;z-index:9999;';
        document.body.appendChild(d);
      }
      d.innerHTML += '<div>[Line ' + line + '] ' + msg + '</div>';
      return false;
    };
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Primary Colors - ìŠ¤ì¹´ì´ ë¸”ë£¨ í…Œë§ˆ */
      --primary: #4DB6E5;
      --primary-light: #7DCBEF;
      --primary-dark: #3AA3D6;
      --primary-darker: #2B8BC0;

      /* Accent Colors */
      --accent-purple: #8B8EE8;
      --accent-mint: #2DD4BF;
      --accent-orange: #F59E0B;
      --accent-light-blue: #E0F4FC;
      --accent-sky: #4DB6E5;

      /* Gradients */
      --gradient-1: linear-gradient(135deg, #7DCBEF 0%, #4DB6E5 100%);
      --gradient-2: linear-gradient(135deg, #4DB6E5 0%, #3AA3D6 100%);
      --gradient-3: linear-gradient(180deg, #4DB6E5 0%, #3AA3D6 100%);
      --gradient-4: linear-gradient(135deg, #3AA3D6 0%, #2B8BC0 100%);
      --gradient-header: linear-gradient(135deg, #4DB6E5 0%, #3AA3D6 100%);
      --gradient-purple: linear-gradient(135deg, #8B8EE8 0%, #7678D9 100%);
      --gradient-mint: linear-gradient(135deg, #2DD4BF 0%, #20B5A2 100%);
      --gradient-orange: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);

      /* Background & Surface */
      --bg: #F2F3F5;
      --bg-alt: #E9ECEF;
      --bg-soft: #E9ECEF;
      --card: #FFFFFF;

      /* Text */
      --text: #2F2F2F;
      --text-sub: #6B7280;
      --text-muted: #9CA3AF;

      /* Status */
      --danger: #EF4444;
      --success: #2DD4BF;
      --warning: #F59E0B;

      /* Border */
      --border: #E5E7EB;
      --radius: 16px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      max-width: 430px;
      margin: 0 auto;
      min-height: 100vh;
      min-height: 100dvh;
      position: relative;
    }

    #mainApp {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      min-height: 100dvh;
      position: relative;
    }

    /* === Header === */
    .header {
      background: var(--gradient-header);
      color: white;
      padding: 16px 20px;
      padding-top: max(16px, env(safe-area-inset-top));
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(77, 182, 229, 0.3);
      border-radius: 0 0 24px 24px;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
    }

    .header .subtitle {
      font-size: 11px;
      opacity: 0.8;
    }

    .header-right {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .header-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
    }

    /* === Pages Container === */
    .pages-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    /* === Tab Pages === */
    .page {
      display: none;
      padding: 16px;
      padding-bottom: 100px;
    }

    .page.active {
      display: block;
      flex: 1;
    }

    /* === Bottom Nav Wrapper === */
    .bottom-nav-wrapper {
      position: sticky;
      bottom: 0;
      padding: 12px;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      margin-top: auto;
      background: linear-gradient(to top, var(--bg) 60%, transparent);
      z-index: 1000;
    }

    /* === Bottom Nav === */
    .bottom-nav {
      width: 100%;
      max-width: 406px;
      margin: 0 auto;
      background: #FFFFFF;
      display: flex;
      justify-content: space-around;
      padding: 10px 8px;
      border: 1px solid var(--border);
      border-radius: 24px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      background: none;
      border: none;
      color: var(--text-sub);
      font-size: 9px;
      font-weight: 500;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .nav-item .icon {
      font-size: 18px;
    }

    .nav-item.active {
      color: var(--primary);
      background: var(--accent-light-blue);
      border-radius: 12px;
    }

    .nav-item.active .icon {
      transform: scale(1.1);
    }

    /* === Cards === */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid var(--border);
    }

    .card-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* === Buttons === */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 20px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: var(--gradient-2);
      color: white;
      box-shadow: 0 4px 12px rgba(77, 182, 229, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(77, 182, 229, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #FF4D6A 0%, #FF6B8A 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 77, 106, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #2DD4BF 0%, #20B5A2 100%);
      color: #3E4958;
      box-shadow: 0 4px 15px rgba(26, 241, 185, 0.3);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background: var(--accent-light-blue);
    }

    .btn-sm {
      padding: 6px 14px;
      font-size: 12px;
      border-radius: 8px;
    }

    .btn-block {
      width: 100%;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* === Form === */
    .form-group {
      margin-bottom: 14px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-sub);
      margin-bottom: 6px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      background: var(--bg);
      outline: none;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--primary);
    }

    /* === Badge === */
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-pending {
      background: #FFF3E0;
      color: #F5A623;
      border: 1px solid #F5A62333;
    }

    .badge-done {
      background: #E8F5E9;
      color: #27AE60;
      border: 1px solid #27AE6033;
    }

    .badge-overdue {
      background: #FFEBEE;
      color: #E74C3C;
      border: 1px solid #E74C3C33;
    }

    /* === Modal === */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 3, 61, 0.8);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 24px;
      padding: 24px;
      width: 90%;
      max-width: 380px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(77, 182, 229, 0.3);
      border: 1px solid var(--border);
    }

    .modal h3 {
      font-size: 18px;
      margin-bottom: 16px;
      text-align: center;
      background: var(--gradient-3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* === Roulette === */
    .roulette-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .roulette-wheel {
      width: 280px;
      height: 280px;
      position: relative;
    }

    .roulette-wheel canvas {
      width: 100%;
      height: 100%;
    }

    .roulette-pointer {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 28px;
      z-index: 10;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    /* === Calendar === */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      text-align: center;
    }

    .calendar-grid .day-header {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-sub);
      padding: 8px 0;
    }

    .calendar-grid .day {
      padding: 8px 4px;
      font-size: 13px;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
    }

    .calendar-grid .day:hover {
      background: var(--bg);
    }

    .calendar-grid .day.today {
      background: var(--gradient-3);
      color: white;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(77, 182, 229, 0.4);
    }

    .calendar-grid .day.other-month {
      color: #B0C4D8;
    }

    .calendar-grid .day .dot {
      width: 5px;
      height: 5px;
      background: var(--accent-blue);
      border-radius: 50%;
      margin: 2px auto 0;
      box-shadow: 0 0 6px var(--accent-blue);
    }

    /* === Members List === */
    .member-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .member-item:last-child {
      border: none;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      overflow: hidden;
    }

    .member-info {
      flex: 1;
    }

    .member-info .name {
      font-weight: 600;
      font-size: 14px;
    }

    .member-info .role {
      font-size: 11px;
      color: var(--text-sub);
    }

    /* === Horizontal Family Members === */
    .family-members-grid {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 0;
    }

    .family-member-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 0;
      max-width: 72px;
      padding: 10px 4px;
      background: var(--bg);
      border-radius: 14px;
      transition: all 0.2s ease;
    }

    .family-member-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(77, 182, 229, 0.15);
    }

    .family-member-card .avatar-large {
      width: 52px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
    }

    .family-member-card .avatar-large img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .family-member-card .member-name {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .family-member-card .member-role {
      font-size: 9px;
      color: var(--text-sub);
      padding: 2px 6px;
      background: white;
      border-radius: 8px;
    }

    /* === Chore item === */
    .chore-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .chore-item .chore-icon {
      font-size: 28px;
    }

    .chore-item .chore-info {
      flex: 1;
    }

    .chore-item .chore-title {
      font-weight: 600;
      font-size: 14px;
    }

    .chore-item .chore-meta {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .chore-item.checked .chore-title {
      text-decoration: line-through;
      color: var(--text-sub);
    }

    /* === Custom Checkbox === */
    .task-checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
      background: white;
    }

    .task-checkbox:hover {
      border-color: var(--primary);
    }

    .task-checkbox.checked {
      background: var(--accent-mint);
      border-color: var(--accent-mint);
    }

    .task-checkbox.checked::after {
      content: 'âœ“';
      color: white;
      font-weight: 700;
      font-size: 14px;
    }

    /* === Fine stat === */
    .fine-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }

    .fine-stat {
      text-align: center;
      padding: 14px 8px;
      background: linear-gradient(135deg, rgba(224, 244, 252, 0.5), rgba(77, 182, 229, 0.1));
      border-radius: 14px;
      border: 1px solid var(--border);
    }

    .fine-stat .amount {
      font-size: 22px;
      font-weight: 800;
      background: var(--gradient-3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .fine-stat .label {
      font-size: 10px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    /* === Supabase Test Panel === */
    .test-panel {
      background: var(--gradient-4);
      color: #eee;
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 8px 32px rgba(77, 182, 229, 0.4);
    }

    .test-panel h4 {
      color: #2DD4BF;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .test-output {
      background: rgba(47, 47, 47, 0.95);
      border-radius: 8px;
      padding: 12px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      color: #E0F4FC;
      line-height: 1.5;
      border: 1px solid rgba(77, 182, 229, 0.3);
    }

    .test-output .error {
      color: #EF4444;
    }

    .test-output .info {
      color: #2DD4BF;
    }

    .test-output .success {
      color: #4ade80;
    }

    .test-output table {
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      overflow: hidden;
    }

    /* === Auth Screen === */
    .auth-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 40px 20px;
      text-align: center;
      background: var(--gradient-1);
    }

    .auth-screen .logo {
      font-size: 72px;
      margin-bottom: 16px;
      filter: drop-shadow(0 8px 16px rgba(77, 182, 229, 0.3));
    }

    .auth-screen h2 {
      font-size: 28px;
      margin-bottom: 8px;
      background: var(--gradient-4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
    }

    .auth-screen p {
      color: var(--primary-darker);
      margin-bottom: 32px;
      font-size: 14px;
    }

    .auth-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 14px;
      padding: 4px;
      box-shadow: 0 4px 20px rgba(77, 182, 229, 0.15);
    }

    .auth-tab {
      padding: 10px 20px;
      border: none;
      background: none;
      font-size: 13px;
      font-weight: 600;
      color: var(--primary);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .auth-tab.active {
      background: var(--gradient-3);
      color: white;
      box-shadow: 0 4px 15px rgba(77, 182, 229, 0.4);
    }

    /* === Section Title === */
    .section-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* === Emoticon Grid === */
    .emoticon-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      padding: 8px;
    }

    .emoticon-item {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
      padding: 4px;
    }

    .emoticon-item img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .emoticon-item:hover {
      transform: scale(1.1);
    }

    .emoticon-item.selected {
      transform: scale(1.15);
      filter: drop-shadow(0 4px 8px rgba(77, 182, 229, 0.5));
    }

    /* === Toast === */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: var(--gradient-4);
      color: white;
      padding: 14px 28px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 500;
      z-index: 300;
      transition: transform 0.3s ease;
      box-shadow: 0 8px 32px rgba(0, 3, 61, 0.6);
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    /* === Connection Status === */
    .conn-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 20px;
    }

    .conn-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .conn-ok .conn-dot {
      background: #00D9A5;
      box-shadow: 0 0 8px #00D9A5;
    }

    .conn-ok {
      background: linear-gradient(135deg, rgba(135, 245, 245, 0.3), rgba(0, 217, 165, 0.2));
      color: #00A080;
      border: 1px solid #87F5F5;
    }

    .conn-fail .conn-dot {
      background: #FF4D6A;
      box-shadow: 0 0 8px #FF4D6A;
    }

    .conn-fail {
      background: linear-gradient(135deg, rgba(255, 230, 235, 0.6), rgba(255, 77, 106, 0.2));
      color: #FF4D6A;
      border: 1px solid #FF4D6A44;
    }

    .conn-loading .conn-dot {
      background: #4DB6E5;
      animation: pulse 1s infinite;
      box-shadow: 0 0 8px #4DB6E5;
    }

    .conn-loading {
      background: linear-gradient(135deg, rgba(224, 244, 252, 0.6), rgba(77, 182, 229, 0.2));
      color: #3AA3D6;
      border: 1px solid rgba(77, 182, 229, 0.3);
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.3
      }
    }

    /* === Bar Chart === */
    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      height: 120px;
      padding: 0 4px;
    }

    .bar-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .bar {
      width: 100%;
      max-width: 36px;
      background: var(--gradient-3);
      border-radius: 8px 8px 0 0;
      transition: height 0.5s ease;
      min-height: 4px;
      box-shadow: 0 4px 12px rgba(77, 182, 229, 0.3);
    }

    .bar-label {
      font-size: 10px;
      color: var(--text-sub);
    }

    .bar-value {
      font-size: 10px;
      font-weight: 600;
    }

    /* === Vote Option === */
    .vote-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: var(--bg);
      border-radius: 10px;
      margin-bottom: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .vote-option:hover {
      border-color: var(--primary-light);
    }

    .vote-option.voted {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(242, 230, 238, 0.6), rgba(151, 125, 255, 0.15));
    }

    .vote-option .vote-bar-bg {
      flex: 1;
      height: 8px;
      background: rgba(151, 125, 255, 0.2);
      border-radius: 4px;
      overflow: hidden;
    }

    .vote-option .vote-bar-fill {
      height: 100%;
      background: var(--gradient-3);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .vote-option .vote-pct {
      font-size: 12px;
      font-weight: 700;
      min-width: 36px;
      text-align: right;
    }

    /* === Meeting Card === */
    .meeting-card {
      border-left: 4px solid;
      border-image: var(--gradient-3) 1;
      padding: 14px;
      background: linear-gradient(135deg, rgba(242, 230, 238, 0.4), rgba(151, 125, 255, 0.08));
      border-radius: 0 12px 12px 0;
      margin-bottom: 10px;
    }

    .meeting-card .meeting-title {
      font-weight: 700;
      font-size: 14px;
    }

    .meeting-card .meeting-meta {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .meeting-card .meeting-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }

    /* === Comment === */
    .comment-item {
      display: flex;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .comment-item:last-child {
      border: none;
    }

    .comment-item .comment-avatar {
      font-size: 24px;
    }

    .comment-item .comment-body {
      flex: 1;
    }

    .comment-item .comment-author {
      font-weight: 600;
      font-size: 12px;
    }

    .comment-item .comment-text {
      font-size: 13px;
      margin-top: 2px;
    }

    .comment-item .comment-time {
      font-size: 10px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    /* === Action Items === */
    .action-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .action-item input[type="checkbox"] {
      accent-color: var(--primary);
    }

    .action-item.done {
      text-decoration: line-through;
      color: var(--text-sub);
    }

    /* === Stat Cards (Phase 2) === */
    .stat-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .stat-card {
      text-align: center;
      padding: 16px 8px;
      background: linear-gradient(135deg, rgba(242, 230, 238, 0.6), rgba(151, 125, 255, 0.15));
      border-radius: 16px;
      border: 1px solid var(--border);
    }

    .stat-card .stat-value {
      font-size: 24px;
      font-weight: 800;
      background: var(--gradient-3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-card .stat-label {
      font-size: 10px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    /* === Weight Slider === */
    .weight-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }

    .weight-row .member-name {
      font-size: 13px;
      font-weight: 600;
      min-width: 50px;
    }

    .weight-row input[type="range"] {
      flex: 1;
      accent-color: var(--primary);
    }

    .weight-row .weight-val {
      font-size: 12px;
      font-weight: 700;
      min-width: 30px;
      text-align: right;
      color: var(--primary);
    }

    /* === Tabs (sub-page) === */
    .sub-tabs {
      display: flex;
      gap: 0;
      background: var(--bg);
      border-radius: 10px;
      padding: 3px;
      margin-bottom: 14px;
    }

    .sub-tab {
      flex: 1;
      padding: 8px;
      border: none;
      background: none;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-sub);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
    }

    .sub-tab.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }
  </style>
</head>

<body>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- PWA Install Banner -->
  <div id="installBanner" style="
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #6C63FF 0%, #4DB6E5 100%);
    color: white;
    padding: 16px 20px;
    z-index: 9999;
    box-shadow: 0 -4px 20px rgba(108, 99, 255, 0.3);
    animation: slideUp 0.3s ease-out;
  ">
    <style>
      @keyframes slideUp {
        from {
          transform: translateY(100%);
        }

        to {
          transform: translateY(0);
        }
      }
    </style>
    <div style="display: flex; align-items: center; justify-content: space-between; max-width: 500px; margin: 0 auto;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 28px;">ğŸ </span>
        <div>
          <div style="font-weight: 700; font-size: 15px;">Family Hub ì„¤ì¹˜</div>
          <div style="font-size: 12px; opacity: 0.9;">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì—¬ ì•±ì²˜ëŸ¼ ì‚¬ìš©í•˜ì„¸ìš”!</div>
        </div>
      </div>
      <div style="display: flex; gap: 8px;">
        <button onclick="installPWA()" style="
          background: white;
          color: #6C63FF;
          border: none;
          padding: 10px 20px;
          border-radius: 25px;
          font-weight: 700;
          font-size: 14px;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        ">ì„¤ì¹˜í•˜ê¸°</button>
        <button onclick="dismissInstall()" style="
          background: rgba(255,255,255,0.2);
          color: white;
          border: none;
          padding: 10px 12px;
          border-radius: 25px;
          font-size: 14px;
          cursor: pointer;
        ">âœ•</button>
      </div>
    </div>
  </div>

  <!-- ========== AUTH SCREEN ========== -->
  <div id="authScreen" class="auth-screen">
    <div class="logo">ğŸ </div>
    <h2>Family Hub</h2>
    <p>ê°€ì¡± ê³µë™ê´€ë¦¬ ì•± í”„ë¡œí† íƒ€ì…</p>

    <!-- Always visible install button -->
    <button id="installBtn" onclick="installPWA()" style="
      background: linear-gradient(135deg, #6C63FF, #4DB6E5);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      margin: 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(108, 99, 255, 0.3);
    ">
      ğŸ“² ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°
    </button>

    <div style="width:100%; max-width:320px;">
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="showAuthTab('login')">ë¡œê·¸ì¸</button>
        <button class="auth-tab" onclick="showAuthTab('create')">ê°€ì¡± ìƒì„±</button>
        <button class="auth-tab" onclick="showAuthTab('join')">ê°€ì¡± ì°¸ì—¬</button>
      </div>

      <div id="authLogin">
        <div class="form-group">
          <label>ì•„ì´ë””</label>
          <input type="text" id="loginIdInput" placeholder="ì•„ì´ë”” ì…ë ¥" value="">
        </div>
        <div class="form-group">
          <label>ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="loginPwInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" value="">
        </div>
        <div class="form-group" style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="saveLoginCheckbox" style="width:18px;height:18px;cursor:pointer;">
          <label for="saveLoginCheckbox" style="cursor:pointer;margin:0;font-size:14px;">ë¡œê·¸ì¸ ì •ë³´ ì €ì¥</label>
        </div>
        <button class="btn btn-primary btn-block" onclick="loginUser()">ë¡œê·¸ì¸</button>
      </div>

      <div id="authCreate" style="display:none;">
        <div class="form-group">
          <label>ê°€ì¡± ì´ë¦„</label>
          <div style="display:flex;gap:8px;">
            <input type="text" id="familyNameInput" placeholder="ì˜ˆ: ìš°ë¦¬ ê°€ì¡±" value="" style="flex:1;"
              oninput="resetFamilyNameCheck()">
            <button class="btn btn-sm" style="background:var(--accent-purple);color:white;white-space:nowrap;"
              onclick="checkFamilyName()">ì¤‘ë³µí™•ì¸</button>
          </div>
          <div id="familyNameCheckResult" style="margin-top:6px;font-size:12px;display:none;"></div>
        </div>
        <div class="form-group">
          <label>ì•„ì´ë””</label>
          <div style="display:flex;gap:8px;">
            <input type="text" id="createUserIdInput" placeholder="ì˜ë¬¸, ìˆ«ì 4ì ì´ìƒ" style="flex:1;"
              oninput="resetUserIdCheck()">
            <button class="btn btn-sm" style="background:var(--accent-purple);color:white;white-space:nowrap;"
              onclick="checkUserId('create')">ì¤‘ë³µí™•ì¸</button>
          </div>
          <div id="createUserIdCheckResult" style="margin-top:6px;font-size:12px;display:none;"></div>
        </div>
        <div class="form-group">
          <label>ë‹‰ë„¤ì„</label>
          <input type="text" id="nicknameInput" placeholder="ì˜ˆ: ì•„ë¹ ">
        </div>
        <div class="form-group">
          <label>ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="createPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ì ì´ìƒ">
        </div>
        <button class="btn btn-primary btn-block" onclick="createFamily()">ê°€ì¡± ìƒì„±í•˜ê¸°</button>
      </div>

      <div id="authJoin" style="display:none;">
        <div class="form-group">
          <label>ê°€ì¡± ì½”ë“œ</label>
          <input type="text" id="familyCodeInput" placeholder="8ìë¦¬ ì½”ë“œ ì…ë ¥" maxlength="8"
            style="text-transform:uppercase; text-align:center; font-size:20px; letter-spacing:4px;">
        </div>
        <div class="form-group">
          <label>ì•„ì´ë””</label>
          <div style="display:flex;gap:8px;">
            <input type="text" id="joinUserIdInput" placeholder="ì˜ë¬¸, ìˆ«ì 4ì ì´ìƒ" style="flex:1;"
              oninput="resetUserIdCheck()">
            <button class="btn btn-sm" style="background:var(--accent-purple);color:white;white-space:nowrap;"
              onclick="checkUserId('join')">ì¤‘ë³µí™•ì¸</button>
          </div>
          <div id="joinUserIdCheckResult" style="margin-top:6px;font-size:12px;display:none;"></div>
        </div>
        <div class="form-group">
          <label>ë‹‰ë„¤ì„</label>
          <input type="text" id="joinNicknameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
        </div>
        <div class="form-group">
          <label>ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="joinPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ì ì´ìƒ">
        </div>
        <button class="btn btn-primary btn-block" onclick="joinFamily()">ê°€ì¡± ì°¸ì—¬í•˜ê¸°</button>
      </div>

    </div>
  </div>
  </div>

  <!-- ========== MAIN APP ========== -->
  <div id="mainApp" style="display:none;">

    <!-- Header -->
    <div class="header">
      <div>
        <h1 id="headerFamilyName">í…ŒìŠ¤íŠ¸ ê°€ì¡±</h1>
        <div class="subtitle" id="headerCode">ì½”ë“œ: ABCD1234</div>
      </div>
      <div class="header-right">
        <div class="conn-status conn-loading" id="connStatus">
          <div class="conn-dot"></div>
          <span id="connText">ì—°ê²° ì¤‘</span>
        </div>
        <button class="header-btn" onclick="showPage('settings')" title="ì„¤ì •">âš™</button>
      </div>
    </div>

    <!-- Pages Container -->
    <div class="pages-container">

      <!-- ===== HOME PAGE ===== -->
      <div class="page active" id="page-home">
        <div class="section-title">
          <span>ğŸ  í™ˆ ëŒ€ì‹œë³´ë“œ</span>
          <span style="font-size:12px;color:var(--text-sub)" id="todayDate"></span>
        </div>

        <!-- Today Schedule -->
        <div class="card" style="border-radius: 20px;">
          <div class="card-title">ğŸ“… ì˜¤ëŠ˜ ì¼ì •</div>
          <div id="todayEvents">
            <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ë¨ -->
          </div>
        </div>

        <!-- Today Chores -->
        <div class="card" style="border-radius: 20px;">
          <div class="card-title">ğŸ§¹ ì˜¤ëŠ˜ ì§‘ì•ˆì¼</div>
          <div id="todayChores">
            <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ë¨ -->
          </div>
        </div>

        <!-- Family Members -->
        <div class="card" style="border-radius: 20px;">
          <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
            <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± êµ¬ì„±ì›</span>
            <div style="display:flex;gap:6px;">
              <button class="btn btn-sm" id="inviteLinkBtn" style="background:var(--accent-green);color:white;font-size:11px;padding:4px 10px;" onclick="showInviteLink()">ğŸ”— ì´ˆëŒ€</button>
              <button class="btn btn-sm" id="addMemberBtn" style="background:var(--accent-purple);color:white;font-size:11px;padding:4px 10px;display:none;" onclick="showModal('addMemberModal')">+ ì¶”ê°€</button>
            </div>
          </div>
          <div id="familyMembers">
            <!-- Filled by JS -->
          </div>
        </div>

        <!-- Upcoming Meeting (ë™ì  ë Œë”ë§) -->
        <div id="homeMeetingCard"></div>

        <!-- Active Vote (ë™ì  ë Œë”ë§) -->
        <div id="homeVoteCard"></div>

        <!-- Fine Alert (ë™ì  ë Œë”ë§) -->
        <div id="homeFineCard"></div>
      </div>

      <!-- ===== CALENDAR PAGE ===== -->
      <div class="page" id="page-calendar">
        <div class="section-title">
          <span>ğŸ“… ì¼ì • ê´€ë¦¬</span>
          <button class="btn btn-primary btn-sm" onclick="showModal('eventModal')">+ ì¼ì • ì¶”ê°€</button>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <button class="btn btn-outline btn-sm" onclick="changeMonth(-1)">â—€</button>
            <strong id="calendarMonth" style="font-size:16px;"></strong>
            <button class="btn btn-outline btn-sm" onclick="changeMonth(1)">â–¶</button>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="card">
          <div class="card-title">ğŸ“‹ ì„ íƒí•œ ë‚ ì˜ ì¼ì •</div>
          <div id="selectedDateEvents">
            <p style="font-size:13px;color:var(--text-sub);text-align:center;padding:20px 0;">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
          </div>
        </div>

        <!-- Google Calendar -->
        <div class="card">
          <div class="card-title">ğŸ“† Google Calendar ì—°ë™</div>

          <!-- Export: ì¼ì •ì„ Google Calendarì— ì¶”ê°€ -->
          <div style="margin-bottom:14px;">
            <div style="font-size:13px;font-weight:600;margin-bottom:8px;">ğŸ“¤ ì¼ì • ë‚´ë³´ë‚´ê¸°</div>
            <p style="font-size:11px;color:var(--text-sub);margin-bottom:8px;">ì„ íƒí•œ ì¼ì •ì„ Google Calendarì— ì¶”ê°€í•©ë‹ˆë‹¤ (ìƒˆ íƒ­ì—ì„œ ì—´ë¦¼)
            </p>
            <select id="gcalExportSelect"
              style="width:100%;padding:8px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;margin-bottom:8px;"></select>
            <button class="btn btn-primary btn-sm btn-block" onclick="exportToGoogleCalendar()">Google Calendarì—
              ì¶”ê°€</button>
            <button class="btn btn-outline btn-sm btn-block" style="margin-top:6px;"
              onclick="exportAllToGoogleCalendar()">ì „ì²´ ì¼ì • í•œë²ˆì— ë‚´ë³´ë‚´ê¸° (.ics ë‹¤ìš´ë¡œë“œ)</button>
          </div>

          <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;">

          <!-- Import: Google Calendarì—ì„œ ê°€ì ¸ì˜¤ê¸° -->
          <div>
            <div style="font-size:13px;font-weight:600;margin-bottom:8px;">ğŸ“¥ ì¼ì • ê°€ì ¸ì˜¤ê¸°</div>
            <p style="font-size:11px;color:var(--text-sub);margin-bottom:8px;">Google Calendarì˜ ê³µê°œ ìº˜ë¦°ë” IDë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë°ëª¨ë¡œ
              í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”</p>
            <div class="form-group">
              <input type="text" id="gcalCalendarId" placeholder="ìº˜ë¦°ë” ID (ì˜ˆ: abc123@group.calendar.google.com)">
            </div>
            <div class="form-group">
              <input type="text" id="gcalApiKey" placeholder="Google API Key (ì„ íƒ)">
            </div>
            <div style="display:flex;gap:6px;">
              <button class="btn btn-outline btn-sm" style="flex:1;" onclick="importFromGoogle()">ê°€ì ¸ì˜¤ê¸°</button>
              <button class="btn btn-sm" style="flex:1;background:var(--bg);color:var(--text);"
                onclick="importGoogleDemo()">ë°ëª¨ ê°€ì ¸ì˜¤ê¸°</button>
            </div>
            <div id="gcalImportResult" style="font-size:12px;color:var(--text-sub);margin-top:8px;"></div>
          </div>
        </div>
      </div>

      <!-- ===== CHORES PAGE ===== -->
      <div class="page" id="page-chores">
        <div class="section-title">
          <span>ğŸ§¹ ì§‘ì•ˆì¼</span>
          <button class="btn btn-primary btn-sm" onclick="showModal('choreModal')">+ ì§‘ì•ˆì¼ ì¶”ê°€</button>
        </div>

        <!-- Roulette Button -->
        <div class="card"
          style="text-align:center;background:linear-gradient(135deg,#3AA3D6 0%,#4DB6E5 50%,#2DD4BF 100%);color:white;box-shadow:0 8px 32px rgba(77,182,229,0.4);border-radius:20px;">
          <div style="font-size:40px;margin-bottom:8px;">ğŸ°</div>
          <div style="font-size:16px;font-weight:700;margin-bottom:4px;">ë£°ë › ëŒë¦¬ê¸°</div>
          <div style="font-size:12px;opacity:0.8;margin-bottom:12px;">ê³µì •í•œ ì§‘ì•ˆì¼ ë¶„ë°°!</div>
          <button class="btn" style="background:white;color:var(--primary);font-weight:700;"
            onclick="showModal('rouletteModal')">
            ë£°ë › ì‹œì‘í•˜ê¸° ğŸ¯
          </button>
        </div>

        <!-- Chore List -->
        <div class="card">
          <div class="card-title">ğŸ“‹ ì§‘ì•ˆì¼ ëª©ë¡</div>
          <div id="choreList"></div>
        </div>

        <!-- Roulette History -->
        <div class="card">
          <div class="card-title">ğŸ² ë£°ë › ê¸°ë¡</div>
          <div id="rouletteHistory"></div>
        </div>
      </div>

      <!-- ===== FINE PAGE ===== -->
      <div class="page" id="page-fines">
        <div class="section-title">
          <span>ğŸ’° ë²Œê¸ˆ ê´€ë¦¬</span>
          <button class="btn btn-primary btn-sm" onclick="showModal('fineRuleModal')">+ ê·œì¹™ ì¶”ê°€</button>
        </div>

        <div class="card">
          <div class="card-title">ğŸ“Š ì´ë²ˆ ë‹¬ í˜„í™©</div>
          <div class="fine-stats">
            <div class="fine-stat">
              <div class="amount" id="totalFines">5,000</div>
              <div class="label">ì´ ë²Œê¸ˆ (ì›)</div>
            </div>
            <div class="fine-stat">
              <div class="amount" style="color:var(--danger)" id="unpaidFines">3,000</div>
              <div class="label">ë¯¸ë‚©</div>
            </div>
            <div class="fine-stat">
              <div class="amount" style="color:var(--success)" id="paidFines">2,000</div>
              <div class="label">ë‚©ë¶€ ì™„ë£Œ</div>
            </div>
          </div>
        </div>

        <!-- Bar Chart -->
        <div class="card">
          <div class="card-title">ğŸ“Š êµ¬ì„±ì›ë³„ ë²Œê¸ˆ</div>
          <div class="bar-chart" id="fineChart"></div>
        </div>

        <!-- Fine Rules -->
        <div class="card">
          <div class="card-title">ğŸ“ ë²Œê¸ˆ ê·œì¹™</div>
          <div id="fineRulesList"></div>
        </div>

        <!-- Fine History -->
        <div class="card">
          <div class="card-title">ğŸ“ ë²Œê¸ˆ ê¸°ë¡</div>
          <div id="fineHistoryList"></div>
        </div>
      </div>

      <!-- ===== MEETING PAGE ===== -->
      <div class="page" id="page-meetings">
        <div class="section-title">
          <span>ğŸ“‹ íšŒì˜</span>
          <button class="btn btn-primary btn-sm" onclick="showModal('meetingModal')">+ íšŒì˜ ìƒì„±</button>
        </div>

        <!-- Upcoming Meetings -->
        <div class="card">
          <div class="card-title">ğŸ“… ì˜ˆì •ëœ íšŒì˜</div>
          <div id="meetingList"></div>
        </div>

        <!-- Meeting Detail (shown when a meeting is selected) -->
        <div class="card" id="meetingDetailCard" style="display:none;">
          <div class="card-title" id="meetingDetailTitle">ğŸ“‹ íšŒì˜ ìƒì„¸</div>

          <!-- Agenda & Comments -->
          <div style="margin-bottom: 14px;">
            <div style="font-size:13px;font-weight:600;margin-bottom:8px;">ğŸ’¬ ì•ˆê±´ ëŒ“ê¸€</div>
            <div id="meetingComments"></div>
            <div style="display:flex;gap:6px;margin-top:8px;">
              <input type="text" id="commentInput" placeholder="ëŒ“ê¸€ ì…ë ¥..."
                style="flex:1;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;">
              <button class="btn btn-primary btn-sm" onclick="addComment()">ì „ì†¡</button>
            </div>
          </div>

          <!-- Meeting Minutes -->
          <div style="margin-bottom: 14px;">
            <div style="font-size:13px;font-weight:600;margin-bottom:8px;">ğŸ“ íšŒì˜ë¡</div>
            <textarea id="meetingMinutes" placeholder="íšŒì˜ë¡ì„ ì‘ì„±í•˜ì„¸ìš”..." rows="4"
              style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:10px;font-size:13px;"></textarea>
            <button class="btn btn-outline btn-sm" style="margin-top:6px;" onclick="saveMeetingMinutes()">íšŒì˜ë¡
              ì €ì¥</button>
          </div>

          <!-- Action Items -->
          <div>
            <div style="font-size:13px;font-weight:600;margin-bottom:8px;">âœ… ì•¡ì…˜ ì•„ì´í…œ</div>
            <div id="actionItemsList"></div>
            <div style="display:flex;gap:6px;margin-top:8px;">
              <input type="text" id="actionItemInput" placeholder="í•  ì¼ ì…ë ¥..."
                style="flex:1;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;">
              <select id="actionItemAssignee"
                style="padding:8px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;"></select>
              <button class="btn btn-primary btn-sm" onclick="addActionItem()">ì¶”ê°€</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== VOTE PAGE ===== -->
      <div class="page" id="page-votes">
        <div class="section-title">
          <span>ğŸ—³ï¸ íˆ¬í‘œ</span>
          <button class="btn btn-primary btn-sm" onclick="showModal('voteModal')">+ íˆ¬í‘œ ìƒì„±</button>
        </div>

        <!-- Active Votes -->
        <div class="card">
          <div class="card-title">ğŸ”¥ ì§„í–‰ ì¤‘ì¸ íˆ¬í‘œ</div>
          <div id="activeVotesList"></div>
        </div>

        <!-- Closed Votes -->
        <div class="card">
          <div class="card-title">ğŸ“Š ì™„ë£Œëœ íˆ¬í‘œ</div>
          <div id="closedVotesList"></div>
        </div>
      </div>

      <!-- ===== STATS PAGE ===== -->
      <div class="page" id="page-stats">
        <div class="section-title"><span>ğŸ“Š í†µê³„ & ë¦¬í¬íŠ¸</span></div>

        <!-- Completion Stats -->
        <div class="card">
          <div class="card-title">ğŸ† ì§‘ì•ˆì¼ ì™„ë£Œìœ¨</div>
          <div class="stat-row">
            <div class="stat-card">
              <div class="stat-value" id="statCompletionRate">78%</div>
              <div class="stat-label">ì´ë²ˆ ì£¼ ì™„ë£Œìœ¨</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statTotalAssigned">23</div>
              <div class="stat-label">ì´ ë°°ì • ê±´ìˆ˜</div>
            </div>
          </div>
          <div class="bar-chart" id="completionChart" style="height:100px;"></div>
        </div>

        <!-- Weekly Assignment Table -->
        <div class="card">
          <div class="card-title">ğŸ“… ì£¼ê°„ ë°°ì •í‘œ</div>
          <div style="overflow-x:auto;">
            <table style="width:100%;font-size:11px;border-collapse:collapse;" id="weeklyTable">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Fine Trend -->
        <div class="card">
          <div class="card-title">ğŸ’° ë²Œê¸ˆ ì¶”ì´ (ìµœê·¼ 4ì£¼)</div>
          <div class="bar-chart" id="fineTrendChart" style="height:100px;"></div>
        </div>

        <!-- Weighted Roulette -->
        <div class="card">
          <div class="card-title">âš–ï¸ ê°€ì¤‘ì¹˜ ë£°ë › ì„¤ì •</div>
          <p style="font-size:12px;color:var(--text-sub);margin-bottom:12px;">ê°’ì´ ë†’ì„ìˆ˜ë¡ ë‹¹ì²¨ í™•ë¥ ì´ ë†’ì•„ì§‘ë‹ˆë‹¤</p>
          <div id="weightSettings"></div>
          <button class="btn btn-primary btn-sm btn-block" style="margin-top:12px;" onclick="spinWeightedRoulette()">ê°€ì¤‘ì¹˜
            ë£°ë › ëŒë¦¬ê¸°</button>
          <div id="weightedRouletteResult"
            style="text-align:center;font-size:16px;font-weight:700;margin-top:12px;min-height:24px;"></div>
        </div>
      </div>

      <!-- ===== SETTINGS / API TEST PAGE ===== -->
      <div class="page" id="page-settings">
        <div class="section-title">
          <span>âš™ ì„¤ì •</span>
          <button class="btn btn-primary btn-sm" id="adminLoginBtn" onclick="toggleAdminLogin()">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</button>
        </div>

        <!-- Admin Only Test Panels -->
        <div id="adminTestPanels" style="display:none !important;">
          <div class="section-title" style="margin-top:8px;"><span>ğŸ”§ ê´€ë¦¬ì ë„êµ¬</span></div>

          <!-- Supabase Connection -->
          <div class="card">
            <div class="card-title">ğŸ”Œ Supabase ì—°ê²°</div>
            <div class="form-group">
              <label>Supabase URL</label>
              <input type="text" id="supabaseUrl" value="https://qvforisbxbapojpafbma.supabase.co">
            </div>
            <div class="form-group">
              <label>Anon Key</label>
              <input type="text" id="supabaseKey"
                value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2Zm9yaXNieGJhcG9qcGFmYm1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDM0NjgsImV4cCI6MjA4NTg3OTQ2OH0.LSfAT1NqD2Y5p1Wp_vG6I_KZ9mY2jrTCjrfyajvpIrk">
            </div>
            <button class="btn btn-primary btn-sm" onclick="connectSupabase()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
          </div>

          <!-- API Test Buttons -->
          <div class="test-panel">
            <h4>ğŸ§ª API í…ŒìŠ¤íŠ¸</h4>
            <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;">
              <button class="btn btn-sm" style="background:#4DB6E5;color:white;" onclick="testAPI('families')">ê°€ì¡±
                ì¡°íšŒ</button>
              <button class="btn btn-sm" style="background:#4DB6E5;color:white;" onclick="testAPI('users')">ì‚¬ìš©ì
                ì¡°íšŒ</button>
              <button class="btn btn-sm" style="background:#4DB6E5;color:white;"
                onclick="testAPI('emoticons')">ì´ëª¨í‹°ì½˜</button>
              <button class="btn btn-sm" style="background:#4DB6E5;color:white;" onclick="testAPI('events')">ì¼ì •</button>
              <button class="btn btn-sm" style="background:#4DB6E5;color:white;"
                onclick="testAPI('chores')">ì§‘ì•ˆì¼</button>
              <button class="btn btn-sm" style="background:#4DB6E5;color:white;"
                onclick="testAPI('assignments')">ë°°ì •</button>
              <button class="btn btn-sm" style="background:#4DB6E5;color:white;" onclick="testAPI('fines')">ë²Œê¸ˆ</button>
              <button class="btn btn-sm" style="background:#4DB6E5;color:white;"
                onclick="testAPI('roulette_spins')">ë£°ë ›ê¸°ë¡</button>
            </div>
            <div class="test-output" id="apiOutput">Supabase ì—°ê²° í›„ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”...</div>
          </div>

          <!-- Custom Query -->
          <div class="test-panel">
            <h4>ğŸ” ì»¤ìŠ¤í…€ ì¿¼ë¦¬</h4>
            <div class="form-group">
              <input type="text" id="customTable" placeholder="í…Œì´ë¸”ëª…" value="families"
                style="background:#0d0d1a;color:white;border-color:#333;">
            </div>
            <div class="form-group">
              <input type="text" id="customSelect" placeholder="select ì»¬ëŸ¼ (ë¹„ìš°ë©´ *)"
                style="background:#0d0d1a;color:white;border-color:#333;">
            </div>
            <div class="form-group">
              <input type="number" id="customLimit" placeholder="limit" value="10"
                style="background:#0d0d1a;color:white;border-color:#333;">
            </div>
            <button class="btn btn-sm btn-success" onclick="runCustomQuery()">ì‹¤í–‰</button>
          </div>
        </div><!-- End adminTestPanels -->

        <!-- App Settings (visible to all) -->
        <div class="card">
          <div class="card-title">ğŸ‘¤ í”„ë¡œí•„ ì„¤ì •</div>
          <div style="text-align:center;margin-bottom:16px;">
            <div style="width:64px;height:64px;margin:0 auto 8px;display:flex;align-items:center;justify-content:center;" id="profileEmoticon">
              <img src="./imo/1.png" alt="ì´ëª¨í‹°ì½˜" style="width:100%;height:100%;object-fit:contain;">
            </div>
            <button class="btn btn-outline btn-sm" onclick="showModal('emoticonModal')">ì´ëª¨í‹°ì½˜ ë³€ê²½</button>
          </div>
          <div class="form-group">
            <label>ë‹‰ë„¤ì„</label>
            <input type="text" id="settingsNickname" value="ì•„ë¹ ">
          </div>
          <div class="form-group">
            <label>ì•Œë¦¼ ì„¤ì •</label>
            <select>
              <option>ëª¨ë“  ì•Œë¦¼</option>
              <option>ì¤‘ìš” ì•Œë¦¼ë§Œ</option>
              <option>ì•Œë¦¼ ë„ê¸°</option>
            </select>
          </div>
        </div>

        <div class="card">
          <button class="btn btn-danger btn-block" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <!-- Bottom Navigation -->
      <div class="bottom-nav-wrapper">
        <div class="bottom-nav">
          <button class="nav-item active" onclick="showPage('home')" data-page="home">
            <span class="icon">ğŸ </span>
            <span>í™ˆ</span>
          </button>
          <button class="nav-item" onclick="showPage('calendar')" data-page="calendar">
            <span class="icon">ğŸ“…</span>
            <span>ì¼ì •</span>
          </button>
          <button class="nav-item" onclick="showPage('chores')" data-page="chores">
            <span class="icon">ğŸ§¹</span>
            <span>ì§‘ì•ˆì¼</span>
          </button>
          <button class="nav-item" onclick="showPage('meetings')" data-page="meetings">
            <span class="icon">ğŸ“‹</span>
            <span>íšŒì˜</span>
          </button>
          <button class="nav-item" onclick="showPage('votes')" data-page="votes">
            <span class="icon">ğŸ—³ï¸</span>
            <span>íˆ¬í‘œ</span>
          </button>
          <button class="nav-item" onclick="showPage('fines')" data-page="fines">
            <span class="icon">ğŸ’°</span>
            <span>ë²Œê¸ˆ</span>
          </button>
          <button class="nav-item" onclick="showPage('stats')" data-page="stats">
            <span class="icon">ğŸ“Š</span>
            <span>í†µê³„</span>
          </button>
          <button class="nav-item" onclick="showPage('settings')" data-page="settings">
            <span class="icon">âš™</span>
            <span>ì„¤ì •</span>
          </button>
        </div>
      </div>

    </div><!-- End Pages Container -->
  </div>

  <!-- ========== MODALS ========== -->

  <!-- Roulette Modal -->
  <div class="modal-overlay" id="rouletteModal">
    <div class="modal">
      <h3>ğŸ° ë£°ë › ëŒë¦¬ê¸°</h3>
      <div class="form-group">
        <label>ì§‘ì•ˆì¼ ì„ íƒ</label>
        <select id="rouletteChore"></select>
      </div>
      <div class="form-group">
        <label>ì°¸ì—¬ì ì„ íƒ</label>
        <div id="rouletteParticipants" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="preventConsecutive" checked>
          ì—°ì† ë‹¹ì²¨ ë°©ì§€
        </label>
      </div>

      <div class="roulette-container" id="rouletteArea" style="display:none;">
        <div class="roulette-wheel">
          <div class="roulette-pointer">â–¼</div>
          <canvas id="rouletteCanvas" width="280" height="280"></canvas>
        </div>
        <div id="rouletteResult" style="font-size:18px;font-weight:700;text-align:center;min-height:30px;"></div>
      </div>

      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn btn-outline" style="flex:1;" onclick="hideModal('rouletteModal')">ë‹«ê¸°</button>
        <button class="btn btn-primary" style="flex:1;" id="spinBtn" onclick="spinRoulette()">ëŒë¦¬ê¸°!</button>
      </div>
    </div>
  </div>

  <!-- Event Modal -->
  <div class="modal-overlay" id="eventModal">
    <div class="modal">
      <h3>ğŸ“… ì¼ì • ì¶”ê°€</h3>
      <div class="form-group">
        <label>ì œëª©</label>
        <input type="text" id="eventTitle" placeholder="ì¼ì • ì œëª©">
      </div>
      <div class="form-group">
        <label>ë‚ ì§œ</label>
        <input type="date" id="eventDate">
      </div>
      <div class="form-group">
        <label>ì‹œê°„</label>
        <input type="time" id="eventTime">
      </div>
      <div class="form-group">
        <label>ê³µê°œ ë²”ìœ„</label>
        <select id="eventScope">
          <option value="family">ê°€ì¡± ì „ì²´</option>
          <option value="personal">ê°œì¸</option>
        </select>
      </div>
      <div class="form-group">
        <label>ë°˜ë³µ</label>
        <select id="eventRecurrence">
          <option value="none">ë°˜ë³µ ì•ˆí•¨</option>
          <option value="daily">ë§¤ì¼</option>
          <option value="weekly">ë§¤ì£¼</option>
          <option value="biweekly">ê²©ì£¼</option>
          <option value="monthly">ë§¤ì›”</option>
          <option value="yearly">ë§¤ë…„</option>
        </select>
      </div>
      <div id="recurrenceEndGroup" class="form-group" style="display:none;">
        <label>ë°˜ë³µ ì¢…ë£Œì¼</label>
        <input type="date" id="eventRecurrenceEnd">
      </div>
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn btn-outline" style="flex:1;" onclick="hideModal('eventModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" style="flex:1;" onclick="addEvent()">ì¶”ê°€</button>
      </div>
    </div>
  </div>

  <!-- Chore Modal -->
  <div class="modal-overlay" id="choreModal">
    <div class="modal">
      <h3>ğŸ§¹ ì§‘ì•ˆì¼ ì¶”ê°€</h3>
      <div class="form-group">
        <label>ì§‘ì•ˆì¼ ì´ë¦„</label>
        <input type="text" id="choreTitle" placeholder="ì˜ˆ: ì„¤ê±°ì§€">
      </div>
      <div class="form-group">
        <label>ì„¤ëª…</label>
        <textarea id="choreDesc" placeholder="ì„¤ëª… (ì„ íƒ)" rows="2"
          style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:10px;"></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn btn-outline" style="flex:1;" onclick="hideModal('choreModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" style="flex:1;" onclick="addChore()">ì¶”ê°€</button>
      </div>
    </div>
  </div>

  <!-- Fine Rule Modal -->
  <div class="modal-overlay" id="fineRuleModal">
    <div class="modal">
      <h3>ğŸ“ ë²Œê¸ˆ ê·œì¹™ ì¶”ê°€</h3>
      <div class="form-group">
        <label>íŠ¸ë¦¬ê±°</label>
        <select id="fineRuleTrigger">
          <option value="chore_incomplete">ì§‘ì•ˆì¼ ë¯¸ì™„ë£Œ</option>
          <option value="late">ì§€ê°</option>
          <option value="meeting_absent">íšŒì˜ ë¶ˆì°¸</option>
          <option value="custom">ì»¤ìŠ¤í…€</option>
        </select>
      </div>
      <div class="form-group">
        <label>ì„¤ëª…</label>
        <input type="text" id="fineRuleDesc" placeholder="ì˜ˆ: ì„¤ê±°ì§€ ì•ˆí•˜ë©´">
      </div>
      <div class="form-group">
        <label>ê¸ˆì•¡ (ì›)</label>
        <input type="number" id="fineRuleAmount" value="1000" min="100" step="100">
      </div>
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn btn-outline" style="flex:1;" onclick="hideModal('fineRuleModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" style="flex:1;" onclick="addFineRule()">ì¶”ê°€</button>
      </div>
    </div>
  </div>

  <!-- Emoticon Modal -->
  <div class="modal-overlay" id="emoticonModal">
    <div class="modal">
      <h3>ğŸ˜€ ì´ëª¨í‹°ì½˜ ì„ íƒ</h3>
      <div class="emoticon-grid" id="emoticonGrid"></div>
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn btn-outline" style="flex:1;" onclick="hideModal('emoticonModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" style="flex:1;" onclick="selectEmoticon()">ì„ íƒ</button>
      </div>
    </div>
  </div>

  <!-- Meeting Modal -->
  <div class="modal-overlay" id="meetingModal">
    <div class="modal">
      <h3>ğŸ“‹ íšŒì˜ ìƒì„±</h3>
      <div class="form-group">
        <label>íšŒì˜ ì œëª©</label>
        <input type="text" id="meetingTitle" placeholder="ì˜ˆ: ì´ë²ˆ ì£¼ ê°€ì¡± íšŒì˜">
      </div>
      <div class="form-group">
        <label>ë‚ ì§œ</label>
        <input type="date" id="meetingDate">
      </div>
      <div class="form-group">
        <label>ì‹œê°„</label>
        <input type="time" id="meetingTime" value="20:00">
      </div>
      <div class="form-group">
        <label>ì•ˆê±´</label>
        <textarea id="meetingAgenda" placeholder="ë…¼ì˜í•  ì•ˆê±´ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3"
          style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:10px;font-size:13px;"></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn btn-outline" style="flex:1;" onclick="hideModal('meetingModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" style="flex:1;" onclick="addMeeting()">ìƒì„±</button>
      </div>
    </div>
  </div>

  <!-- Vote Modal -->
  <div class="modal-overlay" id="voteModal">
    <div class="modal">
      <h3>ğŸ—³ï¸ íˆ¬í‘œ ìƒì„±</h3>
      <div class="form-group">
        <label>íˆ¬í‘œ ì œëª©</label>
        <input type="text" id="voteTitle" placeholder="ì˜ˆ: ì£¼ë§ ì™¸ì‹ ì¥ì†Œ">
      </div>
      <div class="form-group">
        <label>ê³µê°œ/ìµëª…</label>
        <select id="voteAnonymous">
          <option value="false">ê³µê°œ íˆ¬í‘œ</option>
          <option value="true">ìµëª… íˆ¬í‘œ</option>
        </select>
      </div>
      <div class="form-group">
        <label>ë³µìˆ˜ ì„ íƒ</label>
        <select id="voteMultiple">
          <option value="false">ë‹¨ì¼ ì„ íƒ</option>
          <option value="true">ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥</option>
        </select>
      </div>
      <div class="form-group">
        <label>ë§ˆê° ê¸°í•œ</label>
        <input type="datetime-local" id="voteDeadline">
      </div>
      <div class="form-group">
        <label>ì„ íƒì§€</label>
        <div id="voteOptionsContainer">
          <div style="display:flex;gap:6px;margin-bottom:6px;">
            <input type="text" class="vote-option-input" placeholder="ì„ íƒì§€ 1"
              style="flex:1;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;">
          </div>
          <div style="display:flex;gap:6px;margin-bottom:6px;">
            <input type="text" class="vote-option-input" placeholder="ì„ íƒì§€ 2"
              style="flex:1;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;">
          </div>
        </div>
        <button class="btn btn-outline btn-sm" onclick="addVoteOptionInput()">+ ì„ íƒì§€ ì¶”ê°€</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn btn-outline" style="flex:1;" onclick="hideModal('voteModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" style="flex:1;" onclick="createVote()">ìƒì„±</button>
      </div>
    </div>
  </div>

  <!-- Vote Detail Modal -->
  <div class="modal-overlay" id="voteDetailModal">
    <div class="modal">
      <h3 id="voteDetailTitle">ğŸ—³ï¸ íˆ¬í‘œ</h3>
      <div id="voteDetailMeta" style="text-align:center;font-size:12px;color:var(--text-sub);margin-bottom:14px;">
      </div>
      <div id="voteDetailOptions"></div>
      <div id="voteDetailVoters" style="margin-top:12px;font-size:11px;color:var(--text-sub);"></div>
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn btn-outline" style="flex:1;" onclick="hideModal('voteDetailModal')">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Admin Login Modal -->
  <div class="modal-overlay" id="adminLoginModal">
    <div class="modal">
      <h3>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
      <form onsubmit="adminLogin(event)">
        <div class="form-group">
          <label>ì•„ì´ë””</label>
          <input type="text" id="adminUsername" autocomplete="username" required>
        </div>
        <div class="form-group">
          <label>ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="adminPassword" autocomplete="current-password" required>
        </div>
        <div id="adminLoginError" style="color:var(--danger);font-size:12px;margin-bottom:12px;display:none;"></div>
        <div style="display:flex;gap:8px;">
          <button type="button" class="btn btn-outline" style="flex:1;"
            onclick="hideModal('adminLoginModal')">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary" style="flex:1;">ë¡œê·¸ì¸</button>
        </div>
      </form>
    </div>
  </div>

  <!-- êµ¬ì„±ì› ì¶”ê°€ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="addMemberModal">
    <div class="modal">
      <h3>ğŸ‘¤ ê°€ì¡± êµ¬ì„±ì› ì¶”ê°€</h3>
      <div class="form-group">
        <label>ì´ëª¨í‹°ì½˜</label>
        <div style="display:flex;align-items:center;gap:12px;">
          <div id="newMemberEmoticon" style="width:48px;height:48px;display:flex;align-items:center;justify-content:center;cursor:pointer;" onclick="showMemberEmoticonPicker()"><img src="./imo/1.png" alt="ì´ëª¨í‹°ì½˜" style="width:100%;height:100%;object-fit:contain;"></div>
          <span style="font-size:12px;color:var(--text-sub);">í´ë¦­í•˜ì—¬ ë³€ê²½</span>
        </div>
        <div id="memberEmoticonPicker" style="display:none;margin-top:8px;background:var(--bg-tertiary);border-radius:8px;padding:8px;max-height:150px;overflow-y:auto;">
          <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;" id="memberEmoticonGrid"></div>
        </div>
      </div>
      <div class="form-group">
        <label>ë‹‰ë„¤ì„ <span style="color:var(--danger);">*</span></label>
        <input type="text" id="newMemberNickname" placeholder="ì˜ˆ: ì•„ë“¤, ë”¸, í• ë¨¸ë‹ˆ">
      </div>
      <div class="form-group">
        <label>ì•„ì´ë”” <span style="color:var(--danger);">*</span></label>
        <input type="text" id="newMemberLoginId" placeholder="ì˜ë¬¸, ìˆ«ì 4ì ì´ìƒ">
      </div>
      <div class="form-group">
        <label>ë¹„ë°€ë²ˆí˜¸ <span style="color:var(--danger);">*</span></label>
        <input type="password" id="newMemberPassword" placeholder="4ì ì´ìƒ">
      </div>
      <div class="form-group">
        <label>ì—­í• </label>
        <select id="newMemberRole">
          <option value="member">ì¼ë°˜ êµ¬ì„±ì›</option>
          <option value="admin">ê´€ë¦¬ì</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn btn-outline" style="flex:1;" onclick="hideModal('addMemberModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" style="flex:1;" onclick="addFamilyMember()">ì¶”ê°€</button>
      </div>
    </div>
  </div>

  <!-- ì´ˆëŒ€ ë§í¬ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="inviteLinkModal">
    <div class="modal" style="max-width:360px;">
      <h3 style="text-align:center;margin-bottom:16px;">ğŸ”— ê°€ì¡± ì´ˆëŒ€ ë§í¬</h3>
      <p style="text-align:center;color:var(--text-secondary);font-size:13px;margin-bottom:16px;">
        ì•„ë˜ ë§í¬ë¥¼ ê°€ì¡±ì—ê²Œ ê³µìœ í•˜ì„¸ìš”.<br>ë§í¬ë¥¼ í†µí•´ ê°€ì¡±ì— ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </p>
      <div style="background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:12px;margin-bottom:12px;">
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px;">ê°€ì¡± ì½”ë“œ</div>
        <div id="inviteFamilyCode" style="font-size:20px;font-weight:700;color:var(--accent-purple);letter-spacing:2px;text-align:center;"></div>
      </div>
      <div style="background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:12px;margin-bottom:16px;">
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px;">ì´ˆëŒ€ ë§í¬</div>
        <input type="text" id="inviteLinkInput" readonly style="width:100%;background:transparent;border:none;font-size:12px;color:var(--text-primary);outline:none;" />
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-outline" style="flex:1;" onclick="hideModal('inviteLinkModal')">ë‹«ê¸°</button>
        <button class="btn btn-primary" style="flex:1;" onclick="copyInviteLink()">ğŸ“‹ ë³µì‚¬</button>
      </div>
    </div>
  </div>

  <!-- ì•± ì„¤ì¹˜ ì•ˆë‚´ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="installGuideModal">
    <div class="modal" style="max-width:340px;">
      <h3 style="text-align:center;margin-bottom:20px;">ğŸ“² ì•± ì„¤ì¹˜ ë°©ë²•</h3>

      <!-- iOS ì•ˆë‚´ -->
      <div id="iosGuide" style="display:none;">
        <div style="background:linear-gradient(135deg,#007AFF,#5856D6);color:white;padding:16px;border-radius:12px;margin-bottom:16px;">
          <div style="font-size:18px;font-weight:700;margin-bottom:12px;">ğŸ iPhone / iPad</div>
          <div style="font-size:13px;line-height:1.6;">Safari ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì„¤ì¹˜ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
        </div>

        <div style="background:var(--bg-secondary);border-radius:12px;padding:16px;">
          <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:16px;">
            <div style="width:32px;height:32px;background:var(--accent-blue);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">1</div>
            <div>
              <div style="font-weight:600;margin-bottom:4px;">ê³µìœ  ë²„íŠ¼ íƒ­</div>
              <div style="font-size:12px;color:var(--text-sub);">í™”ë©´ í•˜ë‹¨ì˜ <span style="background:#333;padding:2px 6px;border-radius:4px;">â–¡â†‘</span> ë²„íŠ¼</div>
            </div>
          </div>

          <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:16px;">
            <div style="width:32px;height:32px;background:var(--accent-blue);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">2</div>
            <div>
              <div style="font-weight:600;margin-bottom:4px;">"í™ˆ í™”ë©´ì— ì¶”ê°€" ì„ íƒ</div>
              <div style="font-size:12px;color:var(--text-sub);">ìŠ¤í¬ë¡¤í•´ì„œ ì°¾ì•„ì£¼ì„¸ìš”</div>
            </div>
          </div>

          <div style="display:flex;align-items:flex-start;gap:12px;">
            <div style="width:32px;height:32px;background:var(--accent-blue);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">3</div>
            <div>
              <div style="font-weight:600;margin-bottom:4px;">"ì¶”ê°€" íƒ­</div>
              <div style="font-size:12px;color:var(--text-sub);">ìš°ì¸¡ ìƒë‹¨ì˜ ì¶”ê°€ ë²„íŠ¼ì„ íƒ­í•˜ë©´ ì™„ë£Œ!</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Android ì•ˆë‚´ -->
      <div id="androidGuide" style="display:none;">
        <div style="background:linear-gradient(135deg,#34A853,#4285F4);color:white;padding:16px;border-radius:12px;margin-bottom:16px;">
          <div style="font-size:18px;font-weight:700;margin-bottom:12px;">ğŸ¤– Android</div>
          <div style="font-size:13px;line-height:1.6;">Chrome ë¸Œë¼ìš°ì € ê¶Œì¥</div>
        </div>

        <div style="background:var(--bg-secondary);border-radius:12px;padding:16px;">
          <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:16px;">
            <div style="width:32px;height:32px;background:var(--accent-green);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">1</div>
            <div>
              <div style="font-weight:600;margin-bottom:4px;">ë©”ë‰´ ë²„íŠ¼ íƒ­</div>
              <div style="font-size:12px;color:var(--text-sub);">ìš°ì¸¡ ìƒë‹¨ì˜ <span style="background:#333;padding:2px 6px;border-radius:4px;">â‹®</span> ë²„íŠ¼</div>
            </div>
          </div>

          <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:16px;">
            <div style="width:32px;height:32px;background:var(--accent-green);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">2</div>
            <div>
              <div style="font-weight:600;margin-bottom:4px;">"ì•± ì„¤ì¹˜" ë˜ëŠ” "í™ˆ í™”ë©´ì— ì¶”ê°€"</div>
              <div style="font-size:12px;color:var(--text-sub);">ë©”ë‰´ì—ì„œ ì„ íƒ</div>
            </div>
          </div>

          <div style="display:flex;align-items:flex-start;gap:12px;">
            <div style="width:32px;height:32px;background:var(--accent-green);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">3</div>
            <div>
              <div style="font-weight:600;margin-bottom:4px;">"ì„¤ì¹˜" íƒ­</div>
              <div style="font-size:12px;color:var(--text-sub);">í™•ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì™„ë£Œ!</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ê¸°ê¸° ì„ íƒ íƒ­ -->
      <div id="deviceSelector" style="display:flex;gap:8px;margin-bottom:16px;">
        <button class="btn" onclick="showInstallGuide('ios')" id="iosTabBtn" style="flex:1;background:var(--bg-tertiary);">ğŸ iOS</button>
        <button class="btn" onclick="showInstallGuide('android')" id="androidTabBtn" style="flex:1;background:var(--bg-tertiary);">ğŸ¤– Android</button>
      </div>

      <button class="btn btn-outline btn-block" onclick="hideModal('installGuideModal')">ë‹«ê¸°</button>
    </div>
  </div>

  <script>
    (function () {
      "use strict";
      // ========== STATE ==========
      var sbClient = null;
      var sbConnecting = null;
      var sbConfig = { url: '', key: '' };
      let currentUser = null;
      let currentFamily = null;
      let calendarDate = new Date();
      let selectedEmoticon = './imo/1.png';
      let isAdminLoggedIn = false;

      // 'test' = ì „ì²´ ë°ì´í„° í‘œì‹œ, 'prod' = ê°€ì¡± ìƒì„± ì‹œ ì˜ˆì‹œ ë°ì´í„°ë§Œ í‘œì‹œ
      const APP_MODE = 'prod';
      function isTestMode() { return APP_MODE === 'test'; }

      // ========== ê°€ì¡± ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ ==========
      async function loadFamilyData() {
        if (!sbClient || !currentFamily?.id) {
          console.log('Supabase ë¯¸ì—°ê²° ë˜ëŠ” ê°€ì¡± ID ì—†ìŒ - ë¡œì»¬ ë°ì´í„° ì‚¬ìš©');
          return;
        }

        const familyId = currentFamily.id;
        console.log('ê°€ì¡± ë°ì´í„° ë¡œë“œ ì‹œì‘:', familyId);

        try {
          // 1. ê°€ì¡± êµ¬ì„±ì› ë¡œë“œ
          const { data: members, error: membersErr } = await sbClient
            .from('users')
            .select('*')
            .eq('family_id', familyId);

          if (!membersErr && members) {
            DEMO_MEMBERS = members.map(m => ({
              nickname: m.nickname,
              role: m.role || 'member',
              emoticon: m.emoticon || './imo/1.png'
            }));
            console.log('êµ¬ì„±ì› ë¡œë“œ:', DEMO_MEMBERS.length);
          }

          // 2. ì§‘ì•ˆì¼ ë¡œë“œ
          const { data: chores, error: choresErr } = await sbClient
            .from('chores')
            .select('*')
            .eq('family_id', familyId);

          if (!choresErr && chores) {
            DEMO_CHORES = chores.map(c => ({
              id: c.id,
              title: c.title,
              icon: c.icon || 'ğŸ“Œ',
              desc: c.description || ''
            }));
            console.log('ì§‘ì•ˆì¼ ë¡œë“œ:', DEMO_CHORES.length);
          }

          // 3. ì¼ì • ë¡œë“œ
          const { data: events, error: eventsErr } = await sbClient
            .from('events')
            .select('*')
            .eq('family_id', familyId);

          if (!eventsErr && events) {
            DEMO_EVENTS = {};
            events.forEach(ev => {
              const date = new Date(ev.start_at);
              const day = date.getDate();
              const time = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
              if (!DEMO_EVENTS[day]) DEMO_EVENTS[day] = [];
              DEMO_EVENTS[day].push({
                id: ev.id,
                title: ev.title,
                time: time,
                scope: ev.scope || 'family',
                recurrence: ev.recurrence_rule ? 'weekly' : 'none',
                createdBy: ev.created_by || null  // ê°œì¸ ì¼ì • ì†Œìœ ì
              });
            });
            console.log('ì¼ì • ë¡œë“œ ì™„ë£Œ');
          }

          // 4. ë²Œê¸ˆ ë¡œë“œ
          const { data: fines, error: finesErr } = await sbClient
            .from('fines')
            .select('*, users(nickname)')
            .eq('family_id', familyId);

          if (!finesErr && fines) {
            DEMO_FINES = fines.map(f => ({
              id: f.id,
              user: f.users?.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ',
              desc: f.description || '',
              amount: f.amount || 0,
              status: f.paid_at ? 'paid' : 'pending'
            }));
            console.log('ë²Œê¸ˆ ë¡œë“œ:', DEMO_FINES.length);
          }

          // 5. ë°°ì • ë¡œë“œ
          const { data: assignments, error: assignErr } = await sbClient
            .from('assignments')
            .select('*, chores(title), users(nickname)')
            .eq('family_id', familyId);

          if (!assignErr && assignments) {
            DEMO_WEEKLY_SCHEDULE = { 'ì›”': {}, 'í™”': {}, 'ìˆ˜': {}, 'ëª©': {}, 'ê¸ˆ': {}, 'í† ': {}, 'ì¼': {} };
            const dayMap = { 0: 'ì¼', 1: 'ì›”', 2: 'í™”', 3: 'ìˆ˜', 4: 'ëª©', 5: 'ê¸ˆ', 6: 'í† ' };
            assignments.forEach(a => {
              if (a.day_of_week !== undefined && a.chores?.title && a.users?.nickname) {
                const dayName = dayMap[a.day_of_week];
                if (dayName) {
                  DEMO_WEEKLY_SCHEDULE[dayName][a.chores.title] = a.users.nickname;
                }
              }
            });
            console.log('ë°°ì • ë¡œë“œ ì™„ë£Œ');
          }

          // 6. ë²Œê¸ˆ ê·œì¹™ ë¡œë“œ
          const { data: fineRules, error: fineRulesErr } = await sbClient
            .from('fine_rules')
            .select('*')
            .eq('family_id', familyId);

          if (!fineRulesErr && fineRules) {
            DEMO_FINE_RULES = fineRules.map(r => ({
              id: r.id,
              trigger: r.trigger || 'custom',
              desc: r.description || '',
              amount: r.amount || 1000
            }));
            console.log('ë²Œê¸ˆ ê·œì¹™ ë¡œë“œ:', DEMO_FINE_RULES.length);
          }

          // 7. íšŒì˜ ë¡œë“œ
          const { data: meetings, error: meetingsErr } = await sbClient
            .from('meetings')
            .select('*')
            .eq('family_id', familyId)
            .order('created_at', { ascending: false });

          if (!meetingsErr && meetings) {
            DEMO_MEETINGS = meetings.map(m => ({
              id: m.id,
              title: m.title,
              date: m.meeting_date || '',
              time: m.meeting_time || '20:00',
              agenda: m.agenda || '',
              status: m.status || 'upcoming',
              comments: [],
              minutes: m.minutes || '',
              actionItems: m.action_items ? JSON.parse(m.action_items) : []
            }));
            console.log('íšŒì˜ ë¡œë“œ:', DEMO_MEETINGS.length);
          }

          // 8. íˆ¬í‘œ ë¡œë“œ
          const { data: votes, error: votesErr } = await sbClient
            .from('votes')
            .select('*')
            .eq('family_id', familyId)
            .order('created_at', { ascending: false });

          if (!votesErr && votes) {
            DEMO_VOTES = votes.map(v => ({
              id: v.id,
              title: v.title,
              anonymous: v.is_anonymous || false,
              multiple: v.is_multiple || false,
              deadline: v.deadline || '',
              status: v.status || 'active',
              options: v.options ? JSON.parse(v.options) : []
            }));
            console.log('íˆ¬í‘œ ë¡œë“œ:', DEMO_VOTES.length);
          }

          showToast('ê°€ì¡± ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
        } catch (e) {
          console.error('ê°€ì¡± ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        }
      }

      // ë°ì´í„° ì´ˆê¸°í™” (ìƒˆ ê°€ì¡± ë˜ëŠ” Supabase ë¯¸ì—°ê²° ì‹œ)
      function initEmptyFamilyData(adminName) {
        DEMO_MEMBERS = [{ nickname: adminName, role: 'admin', emoticon: selectedEmoticon }];
        DEMO_CHORES = [];
        DEMO_FINES = [];
        DEMO_EVENTS = {};
        DEMO_MEETINGS = [];
        DEMO_VOTES = [];
        DEMO_WEEKLY_SCHEDULE = { 'ì›”': {}, 'í™”': {}, 'ìˆ˜': {}, 'ëª©': {}, 'ê¸ˆ': {}, 'í† ': {}, 'ì¼': {} };
        TODAY_EVENTS = [];
        TODAY_CHORES = [];
      }

      // ì´ëª¨í‹°ì½˜ ì´ë¯¸ì§€ ëª©ë¡ (imo í´ë”)
      const EMOTICONS = [
        './imo/1.png', './imo/2.png', './imo/3.png', './imo/4.png', './imo/5.png',
        './imo/6.png', './imo/7.png', './imo/8.png', './imo/9.png', './imo/10.png',
        './imo/gp.png', './imo/gm.png'
      ];

      var DEMO_MEMBERS = [];

      var DEMO_CHORES = [];

      var DEMO_FINE_RULES = [
        { trigger: 'chore_incomplete', desc: 'ì§‘ì•ˆì¼ ë¯¸ì™„ë£Œ', amount: 1000 },
        { trigger: 'late', desc: 'ê·€ê°€ ì‹œê°„ ì´ˆê³¼', amount: 2000 },
        { trigger: 'meeting_absent', desc: 'ê°€ì¡± íšŒì˜ ë¶ˆì°¸', amount: 1500 },
      ];

      var DEMO_FINES = [];

      var DEMO_EVENTS = {};

      let rouletteSpinHistory = [];
      let lastWinner = null;

      // ì˜¤ëŠ˜ì˜ ì¼ì • ë° ì§‘ì•ˆì¼ ë°ì´í„°
      var TODAY_EVENTS = [];

      var TODAY_CHORES = [];

      // Phase 2 data
      var DEMO_MEETINGS = [];

      var DEMO_VOTES = [];

      let selectedMeetingId = null;

      var DEMO_WEEKLY_SCHEDULE = {
        'ì›”': {},
        'í™”': {},
        'ìˆ˜': {},
        'ëª©': {},
        'ê¸ˆ': {},
        'í† ': {},
        'ì¼': {},
      };

      function resetDemoDataForProduction() {
        const adminName = (currentUser && currentUser.nickname) ? currentUser.nickname : 'ê°€ì¡±ì¥';
        const adminEmoticon = (currentUser && currentUser.emoticon) ? currentUser.emoticon : './imo/1.png';

        // ê°€ì¡± ìƒì„± ì‹œ ëª¨ë“  ë°ì´í„°ë¥¼ ë¹ˆ ìƒíƒœë¡œ ì´ˆê¸°í™”
        DEMO_MEMBERS = [
          { nickname: adminName, role: 'admin', emoticon: adminEmoticon },
        ];

        DEMO_CHORES = [];

        DEMO_FINE_RULES = [
          { trigger: 'chore_incomplete', desc: 'ì§‘ì•ˆì¼ ë¯¸ì™„ë£Œ', amount: 1000 },
          { trigger: 'late', desc: 'ê·€ê°€ ì‹œê°„ ì´ˆê³¼', amount: 2000 },
        ];

        DEMO_FINES = [];

        DEMO_EVENTS = {};

        DEMO_MEETINGS = [];

        DEMO_VOTES = [];

        DEMO_WEEKLY_SCHEDULE = {
          'ì›”': {},
          'í™”': {},
          'ìˆ˜': {},
          'ëª©': {},
          'ê¸ˆ': {},
          'í† ': {},
          'ì¼': {},
        };

        TODAY_EVENTS = [];

        TODAY_CHORES = [];

        rouletteSpinHistory = [];
        lastWinner = null;
      }

      // ========== UTILS ==========
      function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
      }

      window.toggleTask = function (checkbox) {
        const item = checkbox.closest('.chore-item');
        const isChecked = checkbox.classList.toggle('checked');
        item.classList.toggle('checked', isChecked);

        // Update badge if exists
        const badge = item.querySelector('.badge');
        if (badge) {
          if (isChecked) {
            badge.className = 'badge badge-done';
            badge.textContent = 'ì™„ë£Œ';
          } else {
            badge.className = 'badge badge-pending';
            badge.textContent = 'ëŒ€ê¸°';
          }
        }

        showToast(isChecked ? 'âœ“ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ëŒ€ê¸° ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }

      function showModal(id) {
        if (id === 'rouletteModal') renderRouletteChores();
        document.getElementById(id).classList.add('show');
      }
      function hideModal(id) { document.getElementById(id).classList.remove('show'); }

      function showPage(name) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + name).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => {
          n.classList.toggle('active', n.dataset.page === name);
        });
      }

      function showAuthTab(tab) {
        const tabs = ['login', 'create', 'join'];
        document.querySelectorAll('.auth-tab').forEach((t, i) => {
          t.classList.toggle('active', tabs[i] === tab);
        });
        document.getElementById('authLogin').style.display = tab === 'login' ? 'block' : 'none';
        document.getElementById('authCreate').style.display = tab === 'create' ? 'block' : 'none';
        document.getElementById('authJoin').style.display = tab === 'join' ? 'block' : 'none';
      }

      function generateCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = '';
        for (let i = 0; i < 8; i++) code += chars[Math.floor(Math.random() * chars.length)];
        return code;
      }

      // Demo accounts for login
      const DEMO_ACCOUNTS = [
        { id: 'mom01', pw: '1234', nickname: 'ì—„ë§ˆ', role: 'admin', emoticon: 'ğŸ¥°', family: 'í…ŒìŠ¤íŠ¸ ê°€ì¡±' },
        { id: 'son01', pw: '1234', nickname: 'ì•„ë“¤', role: 'member', emoticon: 'ğŸ˜„', family: 'í…ŒìŠ¤íŠ¸ ê°€ì¡±' },
        { id: 'daughter01', pw: '1234', nickname: 'ë”¸', role: 'member', emoticon: 'ğŸ˜Š', family: 'í…ŒìŠ¤íŠ¸ ê°€ì¡±' },
      ];

      // ========== AUTH ==========
      // ì €ì¥ëœ ë¡œê·¸ì¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
      function loadSavedLogin() {
        const savedLogin = localStorage.getItem('familyHubLogin');
        if (savedLogin) {
          try {
            const { id, pw } = JSON.parse(savedLogin);
            document.getElementById('loginIdInput').value = id || '';
            document.getElementById('loginPwInput').value = pw || '';
            document.getElementById('saveLoginCheckbox').checked = true;
          } catch (e) {
            console.error('ì €ì¥ëœ ë¡œê·¸ì¸ ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:', e);
            localStorage.removeItem('familyHubLogin');
          }
        }
      }

      // ë¡œê·¸ì¸ ì •ë³´ ì €ì¥
      function saveLoginCredentials(id, pw) {
        const saveCheckbox = document.getElementById('saveLoginCheckbox');
        if (saveCheckbox && saveCheckbox.checked) {
          localStorage.setItem('familyHubLogin', JSON.stringify({ id, pw }));
        } else {
          localStorage.removeItem('familyHubLogin');
        }
      }

      async function loginUser() {
        const id = document.getElementById('loginIdInput').value.trim();
        const pw = document.getElementById('loginPwInput').value.trim();
        if (!id || !pw) return showToast('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');

        // Check demo accounts first
        const account = DEMO_ACCOUNTS.find(a => a.id === id && a.pw === pw);

        if (account) {
          saveLoginCredentials(id, pw);
          currentFamily = { name: account.family, code: generateCode() };
          currentUser = { nickname: account.nickname, role: account.role, emoticon: account.emoticon, loginId: account.id };
          enterApp();
          showToast(account.nickname + 'ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!');
          return;
        }

        // Try Supabase login if connected
        if (sbClient) {
          try {
            appendOutput('ë¡œê·¸ì¸ ì‹œë„: ' + id, 'info');

            // 1ë‹¨ê³„: ì‚¬ìš©ì ì¡°íšŒ (ì™¸ë˜í‚¤ ì¡°ì¸ ì—†ì´)
            const { data: userData, error: userError } = await sbClient.from('users')
              .select('*')
              .eq('login_id', id)
              .single();

            if (userError) {
              appendOutput('ì‚¬ìš©ì ì¡°íšŒ ì‹¤íŒ¨: ' + userError.message, 'error');
            } else if (userData) {
              // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¹„êµ)
              if (userData.password_hash !== pw) {
                appendOutput('ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜', 'error');
              } else {
                // 2ë‹¨ê³„: ê°€ì¡± ì •ë³´ ì¡°íšŒ
                const { data: familyData, error: familyError } = await sbClient.from('families')
                  .select('*')
                  .eq('id', userData.family_id)
                  .single();

                if (familyError) {
                  appendOutput('ê°€ì¡± ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ' + familyError.message, 'error');
                } else if (familyData) {
                  saveLoginCredentials(id, pw);
                  currentFamily = { name: familyData.family_name, code: familyData.family_code, id: familyData.id };
                  currentUser = { nickname: userData.nickname, role: userData.role, emoticon: userData.emoticon || './imo/1.png', loginId: id };
                  enterApp();
                  showToast(userData.nickname + 'ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!');
                  return;
                }
              }
            }
          } catch (e) {
            appendOutput('ë¡œê·¸ì¸ ì—ëŸ¬: ' + e.message, 'error');
            console.error('ë¡œê·¸ì¸ ì—ëŸ¬:', e);
          }
        }

        showToast('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
      }

      // ê°€ì¡±ëª… ì¤‘ë³µì²´í¬ ìƒíƒœ
      let familyNameChecked = false;
      let checkedFamilyName = '';

      // ê¸°ì¡´ ê°€ì¡±ëª… ëª©ë¡ (ë°ëª¨ìš©, ì‹¤ì œë¡œëŠ” DBì—ì„œ ì¡°íšŒ)
      const EXISTING_FAMILY_NAMES = ['í…ŒìŠ¤íŠ¸ ê°€ì¡±', 'í–‰ë³µí•œ ê°€ì¡±', 'ìš°ë¦¬ ê°€ì¡±', 'ê¹€ì”¨ ê°€ì¡±', 'ì´ì”¨ë„¤'];

      async function checkFamilyName() {
        const name = document.getElementById('familyNameInput').value.trim();
        const resultEl = document.getElementById('familyNameCheckResult');

        if (!name) {
          showToast('ê°€ì¡± ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
          return;
        }

        if (name.length < 2) {
          resultEl.style.display = 'block';
          resultEl.innerHTML = '<span style="color:var(--danger);">âš ï¸ ê°€ì¡± ì´ë¦„ì€ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤</span>';
          familyNameChecked = false;
          return;
        }

        // Supabase ì—°ê²°ëœ ê²½ìš° DBì—ì„œ í™•ì¸
        if (sbClient) {
          try {
            appendOutput('ê°€ì¡±ëª… ì¤‘ë³µ í™•ì¸: ' + name, 'info');
            const { data, error } = await sbClient.from('families')
              .select('family_name')
              .eq('family_name', name);

            if (error) {
              appendOutput('DB ì—ëŸ¬: ' + error.message, 'error');
              // DB ì—ëŸ¬ ì‹œ ë¡œì»¬ ì²´í¬ë¡œ í´ë°±
              checkLocalFamilyName(name, resultEl);
              return;
            }

            if (data && data.length > 0) {
              resultEl.style.display = 'block';
              resultEl.innerHTML = '<span style="color:var(--danger);">âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê°€ì¡± ì´ë¦„ì…ë‹ˆë‹¤</span>';
              familyNameChecked = false;
              showToast('âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê°€ì¡± ì´ë¦„ì…ë‹ˆë‹¤');
              appendOutput('ê°€ì¡±ëª… ì¤‘ë³µ: ' + name);
            } else {
              resultEl.style.display = 'block';
              resultEl.innerHTML = '<span style="color:var(--success);">âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ê°€ì¡± ì´ë¦„ì…ë‹ˆë‹¤</span>';
              familyNameChecked = true;
              checkedFamilyName = name;
              showToast('âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ê°€ì¡± ì´ë¦„ì…ë‹ˆë‹¤!');
              appendOutput('ê°€ì¡±ëª… ì‚¬ìš© ê°€ëŠ¥: ' + name);
            }
          } catch (e) {
            appendOutput('ì—ëŸ¬: ' + e.message, 'error');
            checkLocalFamilyName(name, resultEl);
          }
        } else {
          // Supabase ë¯¸ì—°ê²° ì‹œ ë¡œì»¬ ì²´í¬
          checkLocalFamilyName(name, resultEl);
        }
      }

      function checkLocalFamilyName(name, resultEl) {
        const isDuplicate = EXISTING_FAMILY_NAMES.some(
          existing => existing.toLowerCase() === name.toLowerCase()
        );

        if (isDuplicate) {
          resultEl.style.display = 'block';
          resultEl.innerHTML = '<span style="color:var(--danger);">âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê°€ì¡± ì´ë¦„ì…ë‹ˆë‹¤</span>';
          familyNameChecked = false;
          showToast('âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê°€ì¡± ì´ë¦„ì…ë‹ˆë‹¤');
        } else {
          resultEl.style.display = 'block';
          resultEl.innerHTML = '<span style="color:var(--success);">âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ê°€ì¡± ì´ë¦„ì…ë‹ˆë‹¤</span>';
          familyNameChecked = true;
          checkedFamilyName = name;
          showToast('âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ê°€ì¡± ì´ë¦„ì…ë‹ˆë‹¤!');
        }
      }

      function resetFamilyNameCheck() {
        familyNameChecked = false;
        checkedFamilyName = '';
        const resultEl = document.getElementById('familyNameCheckResult');
        if (resultEl) {
          resultEl.style.display = 'none';
          resultEl.innerHTML = '';
        }
      }

      // ì•„ì´ë”” ì¤‘ë³µì²´í¬ ìƒíƒœ
      let userIdChecked = false;
      let checkedUserId = '';

      async function checkUserId(mode) {
        const inputId = mode === 'create' ? 'createUserIdInput' : 'joinUserIdInput';
        const resultId = mode === 'create' ? 'createUserIdCheckResult' : 'joinUserIdCheckResult';
        const userId = document.getElementById(inputId).value.trim();
        const resultEl = document.getElementById(resultId);

        if (!userId) {
          showToast('ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
          return;
        }

        // ì•„ì´ë”” í˜•ì‹ ê²€ì¦ (ì˜ë¬¸, ìˆ«ìë§Œ, 4ì ì´ìƒ)
        if (!/^[a-zA-Z0-9]{4,}$/.test(userId)) {
          resultEl.style.display = 'block';
          resultEl.innerHTML = '<span style="color:var(--danger);">âš ï¸ ì˜ë¬¸, ìˆ«ìë§Œ 4ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”</span>';
          userIdChecked = false;
          return;
        }

        // Supabase ì—°ê²°ëœ ê²½ìš° DBì—ì„œ í™•ì¸
        if (sbClient) {
          try {
            appendOutput('ì•„ì´ë”” ì¤‘ë³µ í™•ì¸: ' + userId, 'info');
            const { data, error } = await sbClient.from('users')
              .select('login_id')
              .eq('login_id', userId);

            if (error) {
              appendOutput('DB ì—ëŸ¬: ' + error.message, 'error');
              checkLocalUserId(userId, resultEl);
              return;
            }

            if (data && data.length > 0) {
              resultEl.style.display = 'block';
              resultEl.innerHTML = '<span style="color:var(--danger);">âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤</span>';
              userIdChecked = false;
              showToast('âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤');
            } else {
              resultEl.style.display = 'block';
              resultEl.innerHTML = '<span style="color:var(--success);">âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤</span>';
              userIdChecked = true;
              checkedUserId = userId;
              showToast('âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤!');
            }
          } catch (e) {
            appendOutput('ì—ëŸ¬: ' + e.message, 'error');
            checkLocalUserId(userId, resultEl);
          }
        } else {
          checkLocalUserId(userId, resultEl);
        }
      }

      function checkLocalUserId(userId, resultEl) {
        // DEMO_ACCOUNTSì—ì„œ ì¤‘ë³µ í™•ì¸
        const isDuplicate = DEMO_ACCOUNTS.some(
          acc => acc.id.toLowerCase() === userId.toLowerCase()
        );

        if (isDuplicate) {
          resultEl.style.display = 'block';
          resultEl.innerHTML = '<span style="color:var(--danger);">âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤</span>';
          userIdChecked = false;
          showToast('âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤');
        } else {
          resultEl.style.display = 'block';
          resultEl.innerHTML = '<span style="color:var(--success);">âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤</span>';
          userIdChecked = true;
          checkedUserId = userId;
          showToast('âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤!');
        }
      }

      function resetUserIdCheck() {
        userIdChecked = false;
        checkedUserId = '';
        ['createUserIdCheckResult', 'joinUserIdCheckResult'].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.style.display = 'none';
            el.innerHTML = '';
          }
        });
      }

      async function createFamily() {
        const name = document.getElementById('familyNameInput').value.trim();
        const userId = document.getElementById('createUserIdInput').value.trim();
        const nick = document.getElementById('nicknameInput').value.trim();
        const pw = document.getElementById('createPasswordInput').value;

        if (!name || !userId || !nick || !pw) return showToast('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');

        // ê°€ì¡±ëª… ì¤‘ë³µì²´í¬ í™•ì¸
        if (!familyNameChecked || checkedFamilyName !== name) {
          showToast('ê°€ì¡± ì´ë¦„ ì¤‘ë³µí™•ì¸ì„ í•´ì£¼ì„¸ìš”');
          return;
        }

        // ì•„ì´ë”” ì¤‘ë³µì²´í¬ í™•ì¸
        if (!userIdChecked || checkedUserId !== userId) {
          showToast('ì•„ì´ë”” ì¤‘ë³µí™•ì¸ì„ í•´ì£¼ì„¸ìš”');
          return;
        }

        // ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ í™•ì¸
        if (pw.length < 4) {
          showToast('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
          return;
        }

        // Supabase ì—°ê²° ì‹œ ìƒì„± ì§ì „ í•œ ë²ˆ ë” ì¤‘ë³µ í™•ì¸
        if (sbClient) {
          try {
            const { data: existingFamily, error: checkError } = await sbClient.from('families')
              .select('family_name')
              .eq('family_name', name);

            if (checkError) {
              appendOutput('ì¤‘ë³µ í™•ì¸ ì—ëŸ¬: ' + checkError.message, 'error');
              showToast('ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
              return;
            }

            if (existingFamily && existingFamily.length > 0) {
              showToast('âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê°€ì¡± ì´ë¦„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
              familyNameChecked = false;
              checkedFamilyName = '';
              const resultEl = document.getElementById('familyNameCheckResult');
              if (resultEl) {
                resultEl.style.display = 'block';
                resultEl.innerHTML = '<span style="color:var(--danger);">âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê°€ì¡± ì´ë¦„ì…ë‹ˆë‹¤</span>';
              }
              return;
            }
          } catch (e) {
            appendOutput('ì¤‘ë³µ í™•ì¸ ì—ëŸ¬: ' + e.message, 'error');
            showToast('ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            return;
          }
        }

        const code = generateCode();
        currentFamily = { name, code };
        currentUser = { id: userId, nickname: nick, role: 'admin', emoticon: 'ğŸ˜' };

        // DEMO_ACCOUNTSì— ìƒˆ ê³„ì • ì¶”ê°€
        DEMO_ACCOUNTS.push({
          id: userId,
          pw: pw,
          nickname: nick,
          role: 'admin',
          emoticon: 'ğŸ˜',
          family: name
        });

        if (!isTestMode()) resetDemoDataForProduction();

        if (sbClient) {
          try {
            appendOutput('ê°€ì¡± ìƒì„± ì‹œë„: ' + name, 'info');

            // UUID ìƒì„±
            const familyId = crypto.randomUUID();
            const newUserId = crypto.randomUUID();

            const { data, error } = await sbClient.from('families').insert({
              id: familyId,
              family_name: name,
              family_code: code
            }).select();

            if (error) {
              appendOutput('DB ì—ëŸ¬: ' + error.message, 'error');
              if (error.message.includes('duplicate') || error.code === '23505') {
                showToast('âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê°€ì¡± ì´ë¦„ì…ë‹ˆë‹¤.');
              } else {
                showToast('ê°€ì¡± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
              }
              return;  // ëª¨ë“  ì—ëŸ¬ì—ì„œ return
            }

            if (data && data[0]) {
              appendOutput('ê°€ì¡± ìƒì„± ì„±ê³µ: ' + JSON.stringify(data));
              currentFamily.id = data[0].id;  // ê°€ì¡± ID ì €ì¥
              EXISTING_FAMILY_NAMES.push(name);

              // ìƒì„±ìë¥¼ users í…Œì´ë¸”ì— ë“±ë¡
              const { error: userErr } = await sbClient.from('users').insert({
                id: newUserId,
                family_id: data[0].id,
                nickname: nick,
                login_id: userId,
                password_hash: pw,
                role: 'admin',
                emoticon: 'ğŸ˜'
              });
              if (userErr) {
                appendOutput('ì‚¬ìš©ì ë“±ë¡ ì—ëŸ¬: ' + userErr.message, 'error');
                showToast('ì‚¬ìš©ì ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + userErr.message);
                return;
              }
              appendOutput('ì‚¬ìš©ì ë“±ë¡ ì„±ê³µ: ' + nick);
            } else {
              appendOutput('ê°€ì¡± ìƒì„± ì‹¤íŒ¨: ë°ì´í„° ì—†ìŒ', 'error');
              showToast('ê°€ì¡± ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              return;
            }
          } catch (e) {
            appendOutput('ì—ëŸ¬: ' + e.message, 'error');
            showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
            return;
          }
        } else {
          appendOutput('Supabase ë¯¸ì—°ê²° - ë¡œì»¬ ëª¨ë“œë¡œ ì§„í–‰', 'info');
          EXISTING_FAMILY_NAMES.push(name);
        }

        // ì¤‘ë³µì²´í¬ ìƒíƒœ ì´ˆê¸°í™”
        familyNameChecked = false;
        checkedFamilyName = '';
        userIdChecked = false;
        checkedUserId = '';

        // ìƒˆ ê°€ì¡± ìƒì„± ì‹œ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
        resetDemoDataForProduction();

        enterApp();
        showToast('ê°€ì¡±ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì½”ë“œ: ' + code);
      }

      async function joinFamily() {
        const code = document.getElementById('familyCodeInput').value.trim().toUpperCase();
        const userId = document.getElementById('joinUserIdInput').value.trim();
        const nick = document.getElementById('joinNicknameInput').value.trim();
        const pw = document.getElementById('joinPasswordInput').value;

        if (!code || !userId || !nick || !pw) return showToast('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');

        // ì•„ì´ë”” ì¤‘ë³µì²´í¬ í™•ì¸
        if (!userIdChecked || checkedUserId !== userId) {
          showToast('ì•„ì´ë”” ì¤‘ë³µí™•ì¸ì„ í•´ì£¼ì„¸ìš”');
          return;
        }

        // ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ í™•ì¸
        if (pw.length < 4) {
          showToast('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
          return;
        }

        let familyName = 'ì°¸ì—¬í•œ ê°€ì¡±';

        if (sbClient) {
          try {
            appendOutput('ê°€ì¡± ì°¸ì—¬ ì‹œë„: ì½”ë“œ=' + code, 'info');
            const { data, error } = await sbClient.from('families')
              .select('*').eq('family_code', code).single();
            if (error) { appendOutput('ê°€ì¡± ì½”ë“œ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message, 'error'); return showToast('ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œì…ë‹ˆë‹¤'); }
            currentFamily = { name: data.family_name, code: data.family_code, id: data.id };
            familyName = data.family_name;
            appendOutput('ê°€ì¡± ì°¸ì—¬ ì„±ê³µ: ' + data.family_name);

            // ì°¸ì—¬ìë¥¼ users í…Œì´ë¸”ì— ë“±ë¡
            const newUserId = crypto.randomUUID();
            const { error: userErr } = await sbClient.from('users').insert({
              id: newUserId,
              family_id: data.id,
              nickname: nick,
              login_id: userId,
              password_hash: pw,
              role: 'member',
              emoticon: 'ğŸ˜Š'
            });
            if (userErr) appendOutput('ì‚¬ìš©ì ë“±ë¡ ì—ëŸ¬: ' + userErr.message, 'error');
            else appendOutput('ì‚¬ìš©ì ë“±ë¡ ì„±ê³µ: ' + nick);
          } catch (e) { appendOutput('ì—ëŸ¬: ' + e.message, 'error'); return; }
        } else {
          currentFamily = { name: familyName, code };
        }

        currentUser = { id: userId, nickname: nick, role: 'member', emoticon: 'ğŸ˜Š' };

        // DEMO_ACCOUNTSì— ìƒˆ ê³„ì • ì¶”ê°€
        DEMO_ACCOUNTS.push({
          id: userId,
          pw: pw,
          nickname: nick,
          role: 'member',
          emoticon: 'ğŸ˜Š',
          family: familyName
        });

        // ì¤‘ë³µì²´í¬ ìƒíƒœ ì´ˆê¸°í™”
        userIdChecked = false;
        checkedUserId = '';

        enterApp();
        showToast('ê°€ì¡±ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤!');
      }

      function quickLogin() {
        currentFamily = { name: 'í…ŒìŠ¤íŠ¸ ê°€ì¡±', code: generateCode() };
        currentUser = { nickname: 'ì•„ë¹ ', role: 'admin', emoticon: 'ğŸ˜' };
        enterApp();
        showToast('ë”ë¯¸ ë°ì´í„°ë¡œ ë¡œê·¸ì¸í–ˆìŠµë‹ˆë‹¤');
      }

      async function enterApp() {
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('headerFamilyName').textContent = currentFamily.name;
        document.getElementById('headerCode').textContent = 'ì½”ë“œ: ' + currentFamily.code;
        document.getElementById('settingsNickname').value = currentUser.nickname;
        document.getElementById('profileEmoticon').innerHTML = renderEmoticonImg(currentUser.emoticon, 48);

        const today = new Date();
        document.getElementById('todayDate').textContent =
          `${today.getFullYear()}.${today.getMonth() + 1}.${today.getDate()}`;

        // Supabaseì—ì„œ ê°€ì¡± ë°ì´í„° ë¡œë“œ
        await loadFamilyData();

        try { renderTodayEvents(); } catch (e) { console.error('renderTodayEvents', e); }
        try { renderTodayChores(); } catch (e) { console.error('renderTodayChores', e); }
        try { renderFamilyMembers(); } catch (e) { console.error('renderFamilyMembers', e); }
        try { updateMemberButtons(); } catch (e) { console.error('updateMemberButtons', e); }
        try { renderHomeMeetingCard(); } catch (e) { console.error('renderHomeMeetingCard', e); }
        try { renderHomeVoteCard(); } catch (e) { console.error('renderHomeVoteCard', e); }
        try { renderHomeFineCard(); } catch (e) { console.error('renderHomeFineCard', e); }
        try { renderCalendar(); } catch (e) { console.error('renderCalendar', e); }
        try { renderChores(); } catch (e) { console.error('renderChores', e); }
        try { renderFines(); } catch (e) { console.error('renderFines', e); }
        try { renderEmoticonGrid(); } catch (e) { console.error('renderEmoticonGrid', e); }
        try { renderRouletteParticipants(); renderRouletteChores(); } catch (e) { console.error('renderRoulette', e); }
        try { renderMeetings(); } catch (e) { console.error('renderMeetings', e); }
        try { renderVotes(); } catch (e) { console.error('renderVotes', e); }
        try { renderStats(); } catch (e) { console.error('renderStats', e); }

        // ê´€ë¦¬ìë§Œ í…ŒìŠ¤íŠ¸ íŒ¨ë„ í‘œì‹œ (admin/family4u ë¡œê·¸ì¸ ì‹œì—ë§Œ)
        const adminPanels = document.getElementById('adminTestPanels');
        if (adminPanels) {
          adminPanels.style.display = isAdminLoggedIn ? 'block' : 'none';
        }
      }

      function logout() {
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('authScreen').style.display = 'flex';
        currentUser = null;
        currentFamily = null;

        // ì €ì¥ëœ ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì…ë ¥ê°’ ì´ˆê¸°í™”
        const savedLogin = localStorage.getItem('familyHubLogin');
        if (!savedLogin) {
          document.getElementById('loginIdInput').value = '';
          document.getElementById('loginPwInput').value = '';
          document.getElementById('saveLoginCheckbox').checked = false;
        }

        showAuthTab('login');
        showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤');
      }

      // ========== RENDER ==========
      function renderTodayEvents() {
        const el = document.getElementById('todayEvents');
        if (!el) return;

        // ê°œì¸ ì¼ì • í•„í„°ë§: ê°€ì¡± ì¼ì •ì€ ëª¨ë‘ í‘œì‹œ, ê°œì¸ ì¼ì •ì€ ë³¸ì¸ ê²ƒë§Œ í‘œì‹œ
        const currentNickname = currentUser ? currentUser.nickname : null;
        const filteredEvents = TODAY_EVENTS.filter(function (e) {
          if (e.scope === 'ê°€ì¡±' || e.scope === 'family') return true;
          if (e.scope === 'ê°œì¸' || e.scope === 'personal') {
            return !e.createdBy || e.createdBy === currentNickname;
          }
          return true;
        });

        if (filteredEvents.length === 0) {
          el.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">ì˜¤ëŠ˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }
        el.innerHTML = filteredEvents.map(e => `
          <div class="chore-item${e.done ? ' checked' : ''}" data-id="${e.id}">
            <div class="task-checkbox${e.done ? ' checked' : ''}" onclick="toggleTodayEvent('${e.id}')"></div>
            <span class="chore-icon">${e.icon}</span>
            <div class="chore-info">
              <div class="chore-title">${e.title}</div>
              <div class="chore-meta">${e.time} Â· ${e.scope}</div>
            </div>
          </div>
        `).join('');
      }

      function renderTodayChores() {
        const el = document.getElementById('todayChores');
        if (!el) return;
        if (TODAY_CHORES.length === 0) {
          el.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">ì˜¤ëŠ˜ ì§‘ì•ˆì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }
        el.innerHTML = TODAY_CHORES.map(c => `
          <div class="chore-item${c.done ? ' checked' : ''}" data-id="${c.id}">
            <div class="task-checkbox${c.done ? ' checked' : ''}" onclick="toggleTodayChore('${c.id}')"></div>
            <span class="chore-icon">${c.icon}</span>
            <div class="chore-info">
              <div class="chore-title">${c.title}</div>
              <div class="chore-meta">ë‹´ë‹¹: ${c.assignee} Â· ${c.deadline}</div>
            </div>
            <span class="badge ${c.done ? 'badge-done' : 'badge-pending'}">${c.done ? 'ì™„ë£Œ' : 'ëŒ€ê¸°'}</span>
          </div>
        `).join('');
      }

      // í™ˆ í™”ë©´ ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜ë“¤
      function renderHomeMeetingCard() {
        const el = document.getElementById('homeMeetingCard');
        if (!el) return;

        const upcomingMeetings = DEMO_MEETINGS.filter(m => m.status === 'upcoming');
        if (upcomingMeetings.length === 0) {
          el.innerHTML = '';  // íšŒì˜ ì—†ìœ¼ë©´ ì¹´ë“œ ìˆ¨ê¹€
          return;
        }

        const meeting = upcomingMeetings[0];
        const agendaCount = meeting.agenda ? meeting.agenda.split('\n').length : 0;
        el.innerHTML = `
          <div class="card" style="border-left: 4px solid var(--primary);">
            <div class="card-title">ğŸ“‹ ë‹¤ê°€ì˜¤ëŠ” íšŒì˜</div>
            <p style="font-size:13px;font-weight:600;">${meeting.title}</p>
            <p style="font-size:11px;color:var(--text-sub);margin-top:2px;">${meeting.date} ${meeting.time} Â· ì•ˆê±´: ${agendaCount}ê±´</p>
            <button class="btn btn-outline btn-sm" style="margin-top:8px;" onclick="showPage('meetings')">íšŒì˜ ë³´ê¸°</button>
          </div>
        `;
      }

      function renderHomeVoteCard() {
        const el = document.getElementById('homeVoteCard');
        if (!el) return;

        const activeVotes = DEMO_VOTES.filter(v => v.status === 'active');
        if (activeVotes.length === 0) {
          el.innerHTML = '';  // íˆ¬í‘œ ì—†ìœ¼ë©´ ì¹´ë“œ ìˆ¨ê¹€
          return;
        }

        const vote = activeVotes[0];
        const totalVotes = vote.options.reduce((sum, opt) => sum + opt.votes.length, 0);
        const deadline = new Date(vote.deadline);
        const deadlineStr = `${deadline.getMonth() + 1}/${deadline.getDate()} ${deadline.getHours()}:${String(deadline.getMinutes()).padStart(2, '0')}`;
        el.innerHTML = `
          <div class="card" style="border-left: 4px solid var(--warning);">
            <div class="card-title">ğŸ—³ï¸ ì§„í–‰ ì¤‘ì¸ íˆ¬í‘œ</div>
            <p style="font-size:13px;font-weight:600;">${vote.title}</p>
            <p style="font-size:11px;color:var(--text-sub);margin-top:2px;">ë§ˆê°: ${deadlineStr} Â· ${totalVotes}ëª… ì°¸ì—¬</p>
            <button class="btn btn-outline btn-sm" style="margin-top:8px;" onclick="showPage('votes')">íˆ¬í‘œí•˜ê¸°</button>
          </div>
        `;
      }

      function renderHomeFineCard() {
        const el = document.getElementById('homeFineCard');
        if (!el) return;

        const pendingFines = DEMO_FINES.filter(f => f.status === 'pending');
        if (pendingFines.length === 0) {
          el.innerHTML = '';  // ë²Œê¸ˆ ì—†ìœ¼ë©´ ì¹´ë“œ ìˆ¨ê¹€
          return;
        }

        const totalAmount = pendingFines.reduce((sum, f) => sum + f.amount, 0);
        const finesByUser = {};
        pendingFines.forEach(f => {
          finesByUser[f.user] = (finesByUser[f.user] || 0) + f.amount;
        });
        const fineDetails = Object.entries(finesByUser).map(([user, amount]) => `${user}: ${amount.toLocaleString()}ì›`).join(' / ');

        el.innerHTML = `
          <div class="card" style="border-left: 4px solid var(--danger);">
            <div class="card-title">ğŸ’° ë²Œê¸ˆ ì•Œë¦¼</div>
            <p style="font-size:13px;">ì´ë²ˆ ë‹¬ ë¯¸ë‚© ë²Œê¸ˆ: <strong style="color:var(--danger);">${totalAmount.toLocaleString()}ì›</strong></p>
            <p style="font-size:11px;color:var(--text-sub);margin-top:4px;">${fineDetails}</p>
          </div>
        `;
      }

      window.toggleTodayEvent = async function (id) {
        const item = TODAY_EVENTS.find(e => e.id === id);
        if (item) {
          item.done = !item.done;
          renderTodayEvents();
          showToast(item.done ? 'âœ“ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ëŒ€ê¸° ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');

          // Supabase ì—…ë°ì´íŠ¸
          if (sbClient && currentFamily?.id && item.dbId) {
            try {
              const { error } = await sbClient.from('events')
                .update({ is_done: item.done })
                .eq('id', item.dbId);
              if (error) console.error('ì¼ì • ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            } catch (e) {
              console.error('ì¼ì • ìƒíƒœ ì—…ë°ì´íŠ¸ ì—ëŸ¬:', e);
            }
          }
        }
      };

      window.toggleTodayChore = async function (id) {
        const item = TODAY_CHORES.find(c => c.id === id);
        if (item) {
          item.done = !item.done;
          renderTodayChores();
          showToast(item.done ? 'âœ“ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ëŒ€ê¸° ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');

          // Supabase ì—…ë°ì´íŠ¸
          if (sbClient && currentFamily?.id && item.dbId) {
            try {
              const { error } = await sbClient.from('chores')
                .update({ is_done: item.done })
                .eq('id', item.dbId);
              if (error) console.error('ì§‘ì•ˆì¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            } catch (e) {
              console.error('ì§‘ì•ˆì¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì—ëŸ¬:', e);
            }
          }
        }
      };

      // ì´ëª¨í‹°ì½˜ ë Œë”ë§ í—¬í¼ í•¨ìˆ˜
      function renderEmoticonImg(emoticon, size = 48) {
        if (emoticon && emoticon.startsWith('./imo/')) {
          return `<img src="${emoticon}" alt="ì´ëª¨í‹°ì½˜" style="max-width:${size}px;max-height:${size}px;width:100%;height:100%;object-fit:contain;">`;
        }
        // ê¸°ì¡´ ì´ëª¨ì§€ í˜¸í™˜
        return `<img src="./imo/1.png" alt="ì´ëª¨í‹°ì½˜" style="max-width:${size}px;max-height:${size}px;width:100%;height:100%;object-fit:contain;">`;
      }

      function renderFamilyMembers() {
        const el = document.getElementById('familyMembers');
        if (DEMO_MEMBERS.length === 0) {
          el.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">ì•„ì§ êµ¬ì„±ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }
        el.innerHTML = `<div class="family-members-grid">` + DEMO_MEMBERS.map(m => `
    <div class="family-member-card">
      <div class="avatar-large">${renderEmoticonImg(m.emoticon, 64)}</div>
      <div class="member-name">${m.nickname}</div>
      <div class="member-role">${m.role === 'admin' ? 'ê´€ë¦¬ì' : 'êµ¬ì„±ì›'}</div>
    </div>
  `).join('') + `</div>`;
      }

      // êµ¬ì„±ì› ì¶”ê°€ìš© ì´ëª¨í‹°ì½˜ ì„ íƒ
      let newMemberEmoticon = './imo/1.png';

      function showMemberEmoticonPicker() {
        const picker = document.getElementById('memberEmoticonPicker');
        const grid = document.getElementById('memberEmoticonGrid');
        if (picker.style.display === 'none') {
          grid.innerHTML = EMOTICONS.map(e =>
            `<div style="cursor:pointer;padding:4px;${e === newMemberEmoticon ? 'transform:scale(1.15);filter:drop-shadow(0 2px 4px rgba(77,182,229,0.5));' : ''}" onclick="selectMemberEmoticon('${e}')">
              <img src="${e}" alt="ì´ëª¨í‹°ì½˜" style="width:100%;height:100%;object-fit:contain;">
            </div>`
          ).join('');
          picker.style.display = 'block';
        } else {
          picker.style.display = 'none';
        }
      }

      function selectMemberEmoticon(emoticon) {
        newMemberEmoticon = emoticon;
        document.getElementById('newMemberEmoticon').innerHTML = `<img src="${emoticon}" alt="ì´ëª¨í‹°ì½˜" style="width:100%;height:100%;object-fit:contain;">`;
        document.getElementById('memberEmoticonPicker').style.display = 'none';
      }

      // ì´ˆëŒ€ ë§í¬ í‘œì‹œ
      function showInviteLink() {
        if (!currentFamily?.code) {
          return showToast('ê°€ì¡± ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤');
        }

        const baseUrl = window.location.origin + window.location.pathname;
        const inviteLink = baseUrl + '?invite=' + currentFamily.code;

        document.getElementById('inviteFamilyCode').textContent = currentFamily.code;
        document.getElementById('inviteLinkInput').value = inviteLink;
        showModal('inviteLinkModal');
      }

      // ì´ˆëŒ€ ë§í¬ ë³µì‚¬
      function copyInviteLink() {
        const linkInput = document.getElementById('inviteLinkInput');
        linkInput.select();
        linkInput.setSelectionRange(0, 99999);

        try {
          navigator.clipboard.writeText(linkInput.value);
          showToast('ğŸ“‹ ì´ˆëŒ€ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch (e) {
          document.execCommand('copy');
          showToast('ğŸ“‹ ì´ˆëŒ€ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
      }

      // ì´ˆëŒ€ ë§í¬ë¡œ ì ‘ì† ì‹œ ìë™ìœ¼ë¡œ ê°€ì¡± ì½”ë“œ ì…ë ¥
      function checkInviteLink() {
        const urlParams = new URLSearchParams(window.location.search);
        const inviteCode = urlParams.get('invite');

        if (inviteCode) {
          // ê°€ì¡± ì°¸ì—¬ íƒ­ìœ¼ë¡œ ì´ë™í•˜ê³  ì½”ë“œ ìë™ ì…ë ¥
          showAuthTab('join');
          const codeInput = document.getElementById('familyCodeInput');
          if (codeInput) {
            codeInput.value = inviteCode;
          }
          showToast('ì´ˆëŒ€ ì½”ë“œê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤!');

          // URLì—ì„œ invite íŒŒë¼ë¯¸í„° ì œê±° (íˆìŠ¤í† ë¦¬ ê¹”ë”í•˜ê²Œ)
          const newUrl = window.location.origin + window.location.pathname;
          window.history.replaceState({}, document.title, newUrl);
        }
      }

      // êµ¬ì„±ì› ì¶”ê°€ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ (ê´€ë¦¬ìë§Œ)
      function updateMemberButtons() {
        const addBtn = document.getElementById('addMemberBtn');
        const inviteBtn = document.getElementById('inviteLinkBtn');

        if (addBtn) {
          // ê´€ë¦¬ìë§Œ ì¶”ê°€ ë²„íŠ¼ ë³´ì´ê¸°
          addBtn.style.display = currentUser?.role === 'admin' ? 'inline-block' : 'none';
        }
        if (inviteBtn) {
          // ì´ˆëŒ€ ë§í¬ëŠ” ëª¨ë“  êµ¬ì„±ì›ì—ê²Œ ë³´ì´ê¸°
          inviteBtn.style.display = currentFamily?.code ? 'inline-block' : 'none';
        }
      }

      async function addFamilyMember() {
        // ê´€ë¦¬ì(ê°€ì¡± ìƒì„±ì)ë§Œ êµ¬ì„±ì› ì¶”ê°€ ê°€ëŠ¥
        if (currentUser?.role !== 'admin') {
          return showToast('ê°€ì¡± ìƒì„±ìë§Œ êµ¬ì„±ì›ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
        }

        const nickname = document.getElementById('newMemberNickname').value.trim();
        const loginId = document.getElementById('newMemberLoginId').value.trim();
        const password = document.getElementById('newMemberPassword').value;
        const role = document.getElementById('newMemberRole').value;

        // ìœ íš¨ì„± ê²€ì‚¬
        if (!nickname) return showToast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
        if (!loginId || loginId.length < 4) return showToast('ì•„ì´ë””ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
        if (!password || password.length < 4) return showToast('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');

        // ì•„ì´ë”” ì¤‘ë³µ ì²´í¬ (ë¡œì»¬)
        const existingAccount = DEMO_ACCOUNTS.find(a => a.id === loginId);
        if (existingAccount) return showToast('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤');

        // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬ (ê°™ì€ ê°€ì¡± ë‚´)
        const existingMember = DEMO_MEMBERS.find(m => m.nickname === nickname);
        if (existingMember) return showToast('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤');

        // Supabaseì— ì €ì¥
        if (sbClient && currentFamily?.id) {
          try {
            // ì•„ì´ë”” ì¤‘ë³µ ì²´í¬ (DB)
            const { data: existingUser } = await sbClient.from('users')
              .select('login_id')
              .eq('login_id', loginId)
              .single();

            if (existingUser) return showToast('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤');

            // ì‚¬ìš©ì ë“±ë¡
            const newUserId = crypto.randomUUID();
            const { error } = await sbClient.from('users').insert({
              id: newUserId,
              family_id: currentFamily.id,
              nickname: nickname,
              login_id: loginId,
              password_hash: password,
              role: role,
              emoticon: newMemberEmoticon
            });

            if (error) {
              console.error('êµ¬ì„±ì› ì¶”ê°€ ì‹¤íŒ¨:', error);
              return showToast('êµ¬ì„±ì› ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
          } catch (e) {
            console.error('êµ¬ì„±ì› ì¶”ê°€ ì—ëŸ¬:', e);
          }
        }

        // ë¡œì»¬ ë°ì´í„°ì— ì¶”ê°€
        DEMO_MEMBERS.push({
          nickname: nickname,
          role: role,
          emoticon: newMemberEmoticon
        });

        // DEMO_ACCOUNTSì—ë„ ì¶”ê°€
        DEMO_ACCOUNTS.push({
          id: loginId,
          pw: password,
          nickname: nickname,
          role: role,
          emoticon: newMemberEmoticon,
          family: currentFamily ? currentFamily.name : ''
        });

        // UI ì—…ë°ì´íŠ¸
        renderFamilyMembers();
        hideModal('addMemberModal');

        // í¼ ì´ˆê¸°í™”
        document.getElementById('newMemberNickname').value = '';
        document.getElementById('newMemberLoginId').value = '';
        document.getElementById('newMemberPassword').value = '';
        document.getElementById('newMemberRole').value = 'member';
        newMemberEmoticon = './imo/1.png';
        document.getElementById('newMemberEmoticon').innerHTML = '<img src="./imo/1.png" alt="ì´ëª¨í‹°ì½˜" style="width:100%;height:100%;object-fit:contain;">';

        showToast(`${nickname}ë‹˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
      }

      function renderCalendar() {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        document.getElementById('calendarMonth').textContent = `${year}ë…„ ${month + 1}ì›”`;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        let html = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].map(d =>
          `<div class="day-header">${d}</div>`).join('');

        const prevDays = new Date(year, month, 0).getDate();
        for (let i = firstDay - 1; i >= 0; i--)
          html += `<div class="day other-month">${prevDays - i}</div>`;

        for (let d = 1; d <= daysInMonth; d++) {
          const isToday = d === today.getDate() && month === today.getMonth() && year === today.getFullYear();
          const hasEvent = DEMO_EVENTS[d];
          html += `<div class="day${isToday ? ' today' : ''}" onclick="selectDate(${d})">
      ${d}${hasEvent ? '<div class="dot"></div>' : ''}
    </div>`;
        }

        const remaining = 42 - firstDay - daysInMonth;
        for (let i = 1; i <= remaining; i++)
          html += `<div class="day other-month">${i}</div>`;

        document.getElementById('calendarGrid').innerHTML = html;
      }

      function changeMonth(delta) {
        calendarDate.setMonth(calendarDate.getMonth() + delta);
        renderCalendar();
      }

      function selectDate(day) {
        const allEvents = DEMO_EVENTS[day];
        const el = document.getElementById('selectedDateEvents');
        if (!allEvents || allEvents.length === 0) {
          el.innerHTML = '<p style="font-size:13px;color:var(--text-sub);text-align:center;padding:20px 0;">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</p>';
          return;
        }

        // ê°œì¸ ì¼ì • í•„í„°ë§: ê°€ì¡± ì¼ì •ì€ ëª¨ë‘ í‘œì‹œ, ê°œì¸ ì¼ì •ì€ ë³¸ì¸ ê²ƒë§Œ í‘œì‹œ
        const currentNickname = currentUser ? currentUser.nickname : null;
        const events = allEvents.filter(function (e) {
          if (e.scope === 'family') return true;  // ê°€ì¡± ì¼ì •ì€ ëª¨ë‘ í‘œì‹œ
          if (e.scope === 'personal') {
            // ê°œì¸ ì¼ì •ì€ ë³¸ì¸ ê²ƒë§Œ í‘œì‹œ (createdByê°€ ì—†ëŠ” ê¸°ì¡´ ë°ì´í„°ëŠ” ëª¨ë‘ í‘œì‹œ)
            return !e.createdBy || e.createdBy === currentNickname;
          }
          return true;
        });

        if (events.length === 0) {
          el.innerHTML = '<p style="font-size:13px;color:var(--text-sub);text-align:center;padding:20px 0;">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</p>';
          return;
        }

        el.innerHTML = events.map(function (e) {
          var recLabel = e.recurrence && e.recurrence !== 'none' ? ' Â· ğŸ” ' + (RECURRENCE_LABELS[e.recurrence] || 'ë°˜ë³µ') : '';
          return '<div class="chore-item">' +
            '<span class="chore-icon">' + (e.scope === 'family' ? 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦' : 'ğŸ‘¤') + '</span>' +
            '<div class="chore-info">' +
            '<div class="chore-title">' + e.title + '</div>' +
            '<div class="chore-meta">' + e.time + ' Â· ' + (e.scope === 'family' ? 'ê°€ì¡±' : 'ê°œì¸') + recLabel + '</div>' +
            '</div>' +
            '</div>';
        }).join('');
      }

      function renderChores() {
        document.getElementById('choreList').innerHTML = DEMO_CHORES.map((c, i) => `
    <div class="chore-item">
      <span class="chore-icon">${c.icon}</span>
      <div class="chore-info">
        <div class="chore-title">${c.title}</div>
        <div class="chore-meta">${c.desc}</div>
      </div>
    </div>
  `).join('');
        renderRouletteHistory();
      }

      function renderRouletteHistory() {
        const el = document.getElementById('rouletteHistory');
        if (rouletteSpinHistory.length === 0) {
          el.innerHTML = '<p style="font-size:13px;color:var(--text-sub);text-align:center;padding:12px;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
          return;
        }
        el.innerHTML = rouletteSpinHistory.slice(-10).reverse().map(h => `
    <div class="chore-item">
      <span class="chore-icon">ğŸ²</span>
      <div class="chore-info">
        <div class="chore-title">${h.chore} â†’ ${h.winner}</div>
        <div class="chore-meta">${h.time} Â· ì°¸ì—¬ì: ${h.participants.join(', ')}</div>
      </div>
    </div>
  `).join('');
      }

      function renderFines() {
        // Rules
        document.getElementById('fineRulesList').innerHTML = DEMO_FINE_RULES.map(r => `
    <div class="chore-item">
      <span class="chore-icon">ğŸ“</span>
      <div class="chore-info">
        <div class="chore-title">${r.desc}</div>
        <div class="chore-meta">${r.trigger} Â· ${r.amount.toLocaleString()}ì›</div>
      </div>
    </div>
  `).join('');

        // History
        document.getElementById('fineHistoryList').innerHTML = DEMO_FINES.map(f => `
    <div class="chore-item">
      <span class="chore-icon">${f.status === 'paid' ? 'âœ…' : 'â³'}</span>
      <div class="chore-info">
        <div class="chore-title">${f.user} - ${f.desc}</div>
        <div class="chore-meta">${f.amount.toLocaleString()}ì›</div>
      </div>
      <span class="badge ${f.status === 'paid' ? 'badge-done' : 'badge-pending'}">${f.status === 'paid' ? 'ë‚©ë¶€' : 'ë¯¸ë‚©'}</span>
    </div>
  `).join('');

        // Chart
        const memberFines = {};
        DEMO_MEMBERS.forEach(m => memberFines[m.nickname] = 0);
        DEMO_FINES.forEach(f => memberFines[f.user] = (memberFines[f.user] || 0) + f.amount);
        const maxFine = Math.max(...Object.values(memberFines), 1);

        document.getElementById('fineChart').innerHTML = Object.entries(memberFines).map(([name, amount]) => `
    <div class="bar-col">
      <div class="bar-value">${(amount / 1000).toFixed(0)}k</div>
      <div class="bar" style="height:${(amount / maxFine) * 100}px;${amount === 0 ? 'background:#ddd;' : ''}"></div>
      <div class="bar-label">${name}</div>
    </div>
  `).join('');
      }

      function renderEmoticonGrid() {
        document.getElementById('emoticonGrid').innerHTML = EMOTICONS.map(e => `
    <div class="emoticon-item${e === selectedEmoticon ? ' selected' : ''}" onclick="pickEmoticon(this, '${e}')">
      <img src="${e}" alt="ì´ëª¨í‹°ì½˜" style="width:100%;height:100%;object-fit:contain;">
    </div>
  `).join('');
      }

      function pickEmoticon(el, emoji) {
        document.querySelectorAll('.emoticon-item').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        selectedEmoticon = emoji;
      }

      async function selectEmoticon() {
        document.getElementById('profileEmoticon').innerHTML = renderEmoticonImg(selectedEmoticon, 48);
        if (currentUser) {
          currentUser.emoticon = selectedEmoticon;

          // DEMO_MEMBERSì—ì„œë„ ì—…ë°ì´íŠ¸
          const memberIdx = DEMO_MEMBERS.findIndex(m => m.nickname === currentUser.nickname);
          if (memberIdx !== -1) {
            DEMO_MEMBERS[memberIdx].emoticon = selectedEmoticon;
          }

          // DEMO_ACCOUNTSì—ì„œë„ ì—…ë°ì´íŠ¸
          const accountIdx = DEMO_ACCOUNTS.findIndex(a => a.nickname === currentUser.nickname);
          if (accountIdx !== -1) {
            DEMO_ACCOUNTS[accountIdx].emoticon = selectedEmoticon;
          }

          // Supabaseì— ì €ì¥
          if (sbClient && currentUser.loginId) {
            try {
              const { error } = await sbClient.from('users')
                .update({ emoticon: selectedEmoticon })
                .eq('login_id', currentUser.loginId);
              if (error) console.error('ì´ëª¨í‹°ì½˜ ì €ì¥ ì‹¤íŒ¨:', error);
            } catch (e) {
              console.error('ì´ëª¨í‹°ì½˜ ì €ì¥ ì—ëŸ¬:', e);
            }
          }

          // ê°€ì¡± êµ¬ì„±ì› ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§
          renderFamilyMembers();
        }
        hideModal('emoticonModal');
        showToast('ì´ëª¨í‹°ì½˜ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
      }

      function renderRouletteParticipants() {
        document.getElementById('rouletteParticipants').innerHTML = DEMO_MEMBERS.map(m => `
    <label style="display:flex;align-items:center;gap:4px;padding:6px 12px;background:var(--bg);border-radius:8px;cursor:pointer;font-size:13px;">
      <input type="checkbox" value="${m.nickname}" checked class="roulette-check">
      ${renderEmoticonImg(m.emoticon, 20)} ${m.nickname}
    </label>
  `).join('');
      }

      function renderRouletteChores() {
        var sel = document.getElementById('rouletteChore');
        if (!sel) return;
        sel.innerHTML = DEMO_CHORES.map(function (c) {
          return '<option value="' + c.title + '">' + c.icon + ' ' + c.title + '</option>';
        }).join('');
      }

      // ========== ROULETTE ==========
      function spinRoulette() {
        const checks = document.querySelectorAll('.roulette-check:checked');
        const participants = Array.from(checks).map(c => c.value);
        if (participants.length < 2) return showToast('ìµœì†Œ 2ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”');

        const preventConsecutive = document.getElementById('preventConsecutive').checked;
        const chore = document.getElementById('rouletteChore').value;

        // Filter out last winner if prevent consecutive
        let pool = [...participants];
        if (preventConsecutive && lastWinner && pool.length > 2 && pool.includes(lastWinner)) {
          pool = pool.filter(p => p !== lastWinner);
        }

        const winnerIdx = Math.floor(Math.random() * pool.length);
        const winner = pool[winnerIdx];

        // Draw & animate wheel
        document.getElementById('rouletteArea').style.display = 'flex';
        document.getElementById('spinBtn').disabled = true;

        const canvas = document.getElementById('rouletteCanvas');
        const ctx = canvas.getContext('2d');
        const colors = ['#6C63FF', '#FF6B6B', '#4CAF50', '#FFB74D', '#29B6F6', '#AB47BC', '#EC407A', '#26A69A'];
        const memberEmojis = {};
        DEMO_MEMBERS.forEach(m => memberEmojis[m.nickname] = m.emoticon);

        const sliceAngle = (Math.PI * 2) / participants.length;
        // Target angle: winner slice at top
        const allIdx = participants.indexOf(winner);
        const targetAngle = Math.PI * 2 * 5 + (Math.PI * 2 - allIdx * sliceAngle - sliceAngle / 2) - Math.PI / 2;

        let currentAngle = 0;
        const duration = 3000;
        const start = performance.now();

        document.getElementById('rouletteResult').textContent = '';

        function drawWheel(angle) {
          ctx.clearRect(0, 0, 280, 280);
          const cx = 140, cy = 140, r = 130;

          participants.forEach((p, i) => {
            const startA = angle + i * sliceAngle;
            const endA = startA + sliceAngle;

            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, r, startA, endA);
            ctx.closePath();
            ctx.fillStyle = colors[i % colors.length];
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Text
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(startA + sliceAngle / 2);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'center';
            // ìº”ë²„ìŠ¤ì—ì„œëŠ” ë‹‰ë„¤ì„ë§Œ í‘œì‹œ (ì´ë¯¸ì§€ëŠ” ìº”ë²„ìŠ¤ì—ì„œ ì²˜ë¦¬ ë¶ˆê°€)
            ctx.fillText(p, r * 0.6, 5);
            ctx.restore();
          });

          // Center circle
          ctx.beginPath();
          ctx.arc(cx, cy, 20, 0, Math.PI * 2);
          ctx.fillStyle = 'white';
          ctx.fill();
          ctx.fillStyle = '#333';
          ctx.font = '16px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('ğŸ¯', cx, cy + 6);
        }

        function animate(now) {
          const elapsed = now - start;
          const progress = Math.min(elapsed / duration, 1);
          // Ease out cubic
          const eased = 1 - Math.pow(1 - progress, 3);
          currentAngle = eased * targetAngle;

          drawWheel(currentAngle);

          if (progress < 1) {
            requestAnimationFrame(animate);
          } else {
            // Done
            lastWinner = winner;
            document.getElementById('rouletteResult').innerHTML =
              `ğŸ‰ <span style="color:var(--primary)">${renderEmoticonImg(memberEmojis[winner], 24)} ${winner}</span> ë‹¹ì²¨!`;
            document.getElementById('spinBtn').disabled = false;

            rouletteSpinHistory.push({
              chore, winner, participants,
              time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
            });
            renderRouletteHistory();

            // Try save to Supabase
            if (sbClient && currentFamily?.id) {
              sbClient.from('roulette_spins').insert({
                family_id: currentFamily.id,
                chore_id: null,
                mode: 'daily',
                participants: participants,
                winner_user_id: null,
                rule_snapshot: { chore, winner, preventConsecutive }
              }).then(({ error }) => {
                if (error) appendOutput('ë£°ë › ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
                else appendOutput('ë£°ë › ê¸°ë¡ Supabase ì €ì¥ ì™„ë£Œ');
              });
            }
          }
        }

        requestAnimationFrame(animate);
      }

      // ========== EVENTS ==========
      var allEvents = []; // { title, date(YYYY-MM-DD), time, scope, recurrence, recurrenceEnd }

      const RECURRENCE_LABELS = {
        none: '', daily: 'ë§¤ì¼', weekly: 'ë§¤ì£¼', biweekly: 'ê²©ì£¼', monthly: 'ë§¤ì›”', yearly: 'ë§¤ë…„'
      };

      function addEvent() {
        const title = document.getElementById('eventTitle').value.trim();
        const date = document.getElementById('eventDate').value;
        const time = document.getElementById('eventTime').value;
        const scope = document.getElementById('eventScope').value;
        const recurrence = document.getElementById('eventRecurrence').value;
        const recurrenceEnd = document.getElementById('eventRecurrenceEnd').value;

        if (!title) return showToast('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');

        const eventDate = date || new Date().toISOString().slice(0, 10);
        const ev = { title, date: eventDate, time: time || 'ì¢…ì¼', scope, recurrence, recurrenceEnd: recurrenceEnd || null };
        allEvents.push(ev);

        // Also add to legacy DEMO_EVENTS for the current month dot display
        const day = new Date(eventDate).getDate();
        if (!DEMO_EVENTS[day]) DEMO_EVENTS[day] = [];
        DEMO_EVENTS[day].push({
          title,
          time: time || 'ì¢…ì¼',
          scope,
          recurrence,
          createdBy: currentUser ? currentUser.nickname : null  // ê°œì¸ ì¼ì • ì†Œìœ ì
        });

        generateRecurringEvents(ev);
        renderCalendar();
        hideModal('eventModal');

        // Reset form
        document.getElementById('eventTitle').value = '';
        document.getElementById('eventRecurrence').value = 'none';
        document.getElementById('recurrenceEndGroup').style.display = 'none';

        showToast(recurrence !== 'none' ? 'ë°˜ë³µ ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ (' + RECURRENCE_LABELS[recurrence] + ')' : 'ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');

        if (sbClient && currentFamily?.id) {
          const startAt = new Date(eventDate + 'T' + (time || '00:00'));
          sbClient.from('events').insert({
            family_id: currentFamily.id,
            created_by: currentUser ? currentUser.nickname : null,  // ê°œì¸ ì¼ì • ì†Œìœ ì ì €ì¥
            title, scope,
            start_at: startAt.toISOString(),
            end_at: new Date(startAt.getTime() + 3600000).toISOString(),
            recurrence_rule: recurrence !== 'none' ? recurrenceToRRule(recurrence) : null,
          }).then(function (res) {
            if (res.error) appendOutput('ì¼ì • ì €ì¥ ì‹¤íŒ¨: ' + res.error.message, 'error');
            else appendOutput('ì¼ì • Supabase ì €ì¥ ì™„ë£Œ');
          });
        }
      }

      function recurrenceToRRule(rec) {
        var map = { daily: 'FREQ=DAILY', weekly: 'FREQ=WEEKLY', biweekly: 'FREQ=WEEKLY;INTERVAL=2', monthly: 'FREQ=MONTHLY', yearly: 'FREQ=YEARLY' };
        return map[rec] || null;
      }

      function generateRecurringEvents(ev) {
        if (!ev.recurrence || ev.recurrence === 'none') return;
        var start = new Date(ev.date);
        var end = ev.recurrenceEnd ? new Date(ev.recurrenceEnd) : new Date(start.getTime() + 90 * 86400000); // 90 days default
        var intervalMap = { daily: 1, weekly: 7, biweekly: 14 };
        var current = new Date(start);

        if (ev.recurrence === 'monthly') {
          var dayOfMonth = current.getDate();
          current.setMonth(current.getMonth() + 1);
          while (current <= end) {
            var d = current.getDate();
            if (!DEMO_EVENTS[d]) DEMO_EVENTS[d] = [];
            DEMO_EVENTS[d].push({ title: ev.title, time: ev.time, scope: ev.scope, recurrence: ev.recurrence });
            current.setMonth(current.getMonth() + 1);
          }
        } else if (ev.recurrence === 'yearly') {
          current.setFullYear(current.getFullYear() + 1);
          while (current <= end) {
            var d2 = current.getDate();
            if (!DEMO_EVENTS[d2]) DEMO_EVENTS[d2] = [];
            DEMO_EVENTS[d2].push({ title: ev.title, time: ev.time, scope: ev.scope, recurrence: ev.recurrence });
            current.setFullYear(current.getFullYear() + 1);
          }
        } else {
          var interval = intervalMap[ev.recurrence] || 7;
          current.setDate(current.getDate() + interval);
          while (current <= end) {
            var d3 = current.getDate();
            if (!DEMO_EVENTS[d3]) DEMO_EVENTS[d3] = [];
            DEMO_EVENTS[d3].push({ title: ev.title, time: ev.time, scope: ev.scope, recurrence: ev.recurrence });
            current.setDate(current.getDate() + interval);
          }
        }
      }

      // ========== GOOGLE CALENDAR ==========

      function renderGcalExportList() {
        var sel = document.getElementById('gcalExportSelect');
        if (!sel) return;
        var opts = '<option value="">-- ì¼ì • ì„ íƒ --</option>';
        var allEvts = getAllFlatEvents();
        allEvts.forEach(function (ev, i) {
          var rec = ev.recurrence && ev.recurrence !== 'none' ? ' [ğŸ”' + (RECURRENCE_LABELS[ev.recurrence] || '') + ']' : '';
          opts += '<option value="' + i + '">' + ev.title + ' (' + ev.date + ' ' + ev.time + ')' + rec + '</option>';
        });
        sel.innerHTML = opts;
      }

      function getAllFlatEvents() {
        // Combine allEvents + DEMO_EVENTS into flat array with date info
        var result = allEvents.slice();
        var now = new Date();
        var y = now.getFullYear(), m = now.getMonth();
        Object.keys(DEMO_EVENTS).forEach(function (day) {
          DEMO_EVENTS[day].forEach(function (ev) {
            var dateStr = y + '-' + String(m + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
            if (!result.some(function (r) { return r.title === ev.title && r.date === dateStr; })) {
              result.push({ title: ev.title, date: dateStr, time: ev.time || 'ì¢…ì¼', scope: ev.scope || 'family', recurrence: ev.recurrence || 'none' });
            }
          });
        });
        return result;
      }

      function exportToGoogleCalendar() {
        var sel = document.getElementById('gcalExportSelect');
        var idx = sel.value;
        if (idx === '') return showToast('ì¼ì •ì„ ì„ íƒí•˜ì„¸ìš”');

        var allEvts = getAllFlatEvents();
        var ev = allEvts[parseInt(idx)];
        if (!ev) return;

        // Google Calendar URL scheme
        var startStr, endStr;
        if (ev.time === 'ì¢…ì¼') {
          startStr = ev.date.replace(/-/g, '');
          endStr = startStr;
        } else {
          startStr = ev.date.replace(/-/g, '') + 'T' + ev.time.replace(/:/g, '') + '00';
          // end = start + 1 hour
          var sd = new Date(ev.date + 'T' + ev.time);
          var ed = new Date(sd.getTime() + 3600000);
          endStr = ed.getFullYear() + String(ed.getMonth() + 1).padStart(2, '0') + String(ed.getDate()).padStart(2, '0')
            + 'T' + String(ed.getHours()).padStart(2, '0') + String(ed.getMinutes()).padStart(2, '0') + '00';
        }

        var params = 'text=' + encodeURIComponent(ev.title)
          + '&dates=' + startStr + '/' + endStr
          + '&ctz=Asia/Seoul';

        if (ev.scope === 'family') params += '&details=' + encodeURIComponent('ê°€ì¡± ì¼ì • - Family Hub');

        if (ev.recurrence && ev.recurrence !== 'none') {
          var rrule = recurrenceToRRule(ev.recurrence);
          params += '&recur=RRULE:' + encodeURIComponent(rrule);
        }

        window.open('https://calendar.google.com/calendar/render?action=TEMPLATE&' + params, '_blank');
        showToast('Google Calendarê°€ ìƒˆ íƒ­ì—ì„œ ì—´ë ¸ìŠµë‹ˆë‹¤');
      }

      function exportAllToGoogleCalendar() {
        var allEvts = getAllFlatEvents();
        if (allEvts.length === 0) return showToast('ë‚´ë³´ë‚¼ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤');

        // Generate ICS file
        var lines = [
          'BEGIN:VCALENDAR',
          'VERSION:2.0',
          'PRODID:-//Family Hub//Prototype//KO',
          'CALSCALE:GREGORIAN',
          'X-WR-CALNAME:Family Hub',
          'X-WR-TIMEZONE:Asia/Seoul',
        ];

        allEvts.forEach(function (ev) {
          lines.push('BEGIN:VEVENT');
          lines.push('SUMMARY:' + ev.title);
          lines.push('DESCRIPTION:' + (ev.scope === 'family' ? 'ê°€ì¡± ì¼ì •' : 'ê°œì¸ ì¼ì •'));

          if (ev.time === 'ì¢…ì¼') {
            lines.push('DTSTART;VALUE=DATE:' + ev.date.replace(/-/g, ''));
            lines.push('DTEND;VALUE=DATE:' + ev.date.replace(/-/g, ''));
          } else {
            lines.push('DTSTART;TZID=Asia/Seoul:' + ev.date.replace(/-/g, '') + 'T' + ev.time.replace(/:/g, '') + '00');
            var sd = new Date(ev.date + 'T' + ev.time);
            var ed = new Date(sd.getTime() + 3600000);
            var endStr = ed.getFullYear() + String(ed.getMonth() + 1).padStart(2, '0') + String(ed.getDate()).padStart(2, '0')
              + 'T' + String(ed.getHours()).padStart(2, '0') + String(ed.getMinutes()).padStart(2, '0') + '00';
            lines.push('DTEND;TZID=Asia/Seoul:' + endStr);
          }

          if (ev.recurrence && ev.recurrence !== 'none') {
            lines.push('RRULE:' + recurrenceToRRule(ev.recurrence));
          }

          lines.push('UID:' + Math.random().toString(36).slice(2) + '@familyhub');
          lines.push('END:VEVENT');
        });

        lines.push('END:VCALENDAR');

        var blob = new Blob([lines.join('\r\n')], { type: 'text/calendar;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'family-hub-events.ics';
        a.click();
        URL.revokeObjectURL(url);
        showToast(allEvts.length + 'ê±´ì˜ ì¼ì •ì„ .ics íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤');
      }

      async function importFromGoogle() {
        var calendarId = document.getElementById('gcalCalendarId').value.trim();
        var apiKey = document.getElementById('gcalApiKey').value.trim();
        var resultEl = document.getElementById('gcalImportResult');

        if (!calendarId) return showToast('ìº˜ë¦°ë” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        if (!apiKey) return showToast('API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”');

        resultEl.innerHTML = 'â³ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';

        try {
          var now = new Date();
          var timeMin = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
          var timeMax = new Date(now.getFullYear(), now.getMonth() + 2, 0).toISOString();

          var resp = await fetch(
            'https://www.googleapis.com/calendar/v3/calendars/' + encodeURIComponent(calendarId)
            + '/events?key=' + apiKey
            + '&timeMin=' + timeMin
            + '&timeMax=' + timeMax
            + '&singleEvents=true&orderBy=startTime&maxResults=50'
          );

          if (!resp.ok) throw new Error('API ì˜¤ë¥˜ ' + resp.status + ': ìº˜ë¦°ë” IDë‚˜ API Keyë¥¼ í™•ì¸í•˜ì„¸ìš”');

          var data = await resp.json();
          var items = data.items || [];
          var imported = 0;

          items.forEach(function (item) {
            var start = item.start.dateTime || item.start.date;
            var d = new Date(start);
            var day = d.getDate();
            var time = item.start.dateTime ? d.toTimeString().slice(0, 5) : 'ì¢…ì¼';
            var title = (item.summary || '(ì œëª© ì—†ìŒ)') + ' (G)';

            if (!DEMO_EVENTS[day]) DEMO_EVENTS[day] = [];
            var exists = DEMO_EVENTS[day].some(function (e) { return e.title === title; });
            if (!exists) {
              DEMO_EVENTS[day].push({ title: title, time: time, scope: 'personal', recurrence: 'none' });
              imported++;
            }
          });

          renderCalendar();
          resultEl.innerHTML = 'âœ… ' + imported + 'ê±´ ê°€ì ¸ì˜´ (ì´ ' + items.length + 'ê±´)';
          showToast('Google Calendarì—ì„œ ' + imported + 'ê±´ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤');
        } catch (e) {
          resultEl.innerHTML = 'âŒ ' + e.message;
        }
      }

      async function importGoogleDemo() {
        var resultEl = document.getElementById('gcalImportResult');
        resultEl.innerHTML = 'â³ ë°ëª¨ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
        await new Promise(function (r) { setTimeout(r, 800); });

        var demoGoogleEvents = [
          { title: 'ğŸ“± íŒ€ ë¯¸íŒ… (G)', time: '10:00', scope: 'personal', recurrence: 'weekly' },
          { title: 'ğŸ‹ï¸ í—¬ìŠ¤ì¥ (G)', time: '07:00', scope: 'personal', recurrence: 'daily' },
          { title: 'ğŸ“ í™”ìƒíšŒì˜ (G)', time: '14:00', scope: 'personal', recurrence: 'none' },
          { title: 'ğŸ‚ ì¹œêµ¬ ìƒì¼ (G)', time: 'ì¢…ì¼', scope: 'personal', recurrence: 'yearly' },
        ];
        var today = new Date().getDate();
        demoGoogleEvents.forEach(function (ev, i) {
          var d = ((today + i + 1) % 28) + 1;
          if (!DEMO_EVENTS[d]) DEMO_EVENTS[d] = [];
          DEMO_EVENTS[d].push(ev);
        });
        renderCalendar();
        resultEl.innerHTML = 'âœ… ' + demoGoogleEvents.length + 'ê±´ ë°ëª¨ ì¼ì • ê°€ì ¸ì˜´';
        showToast(demoGoogleEvents.length + 'ê±´ì˜ Google ì¼ì •ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤ (ë°ëª¨)');
      }

      async function addChore() {
        const title = document.getElementById('choreTitle').value.trim();
        const desc = document.getElementById('choreDesc').value || '';
        if (!title) return showToast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');

        // ë¡œì»¬ ë°ì´í„°ì— ì¶”ê°€
        DEMO_CHORES.push({ title, icon: 'ğŸ“Œ', desc });

        // Supabaseì— ì €ì¥
        if (sbClient && currentFamily?.id) {
          try {
            const choreId = crypto.randomUUID();
            const { error } = await sbClient.from('chores').insert({
              id: choreId,
              family_id: currentFamily.id,
              title: title,
              description: desc,
              assigned_to: null,
              due_date: null,
              is_done: false
            });
            if (error) {
              console.error('ì§‘ì•ˆì¼ ì €ì¥ ì‹¤íŒ¨:', error);
            }
          } catch (e) {
            console.error('ì§‘ì•ˆì¼ ì €ì¥ ì—ëŸ¬:', e);
          }
        }

        renderChores();
        renderRouletteChores();
        hideModal('choreModal');
        document.getElementById('choreTitle').value = '';
        document.getElementById('choreDesc').value = '';
        showToast('ì§‘ì•ˆì¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
      }

      async function addFineRule() {
        const trigger = document.getElementById('fineRuleTrigger').value;
        const desc = document.getElementById('fineRuleDesc').value.trim();
        const amount = parseInt(document.getElementById('fineRuleAmount').value) || 1000;
        if (!desc) return showToast('ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');

        // ë¡œì»¬ ë°ì´í„°ì— ì¶”ê°€
        const ruleId = crypto.randomUUID();
        DEMO_FINE_RULES.push({ id: ruleId, trigger, desc, amount });

        // Supabaseì— ì €ì¥
        if (sbClient && currentFamily?.id) {
          try {
            const { error } = await sbClient.from('fine_rules').insert({
              id: ruleId,
              family_id: currentFamily.id,
              trigger: trigger,
              description: desc,
              amount: amount,
              is_active: true
            });
            if (error) {
              console.error('ë²Œê¸ˆ ê·œì¹™ ì €ì¥ ì‹¤íŒ¨:', error);
              appendOutput('ë²Œê¸ˆ ê·œì¹™ ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            } else {
              appendOutput('ë²Œê¸ˆ ê·œì¹™ Supabase ì €ì¥ ì™„ë£Œ');
            }
          } catch (e) {
            console.error('ë²Œê¸ˆ ê·œì¹™ ì €ì¥ ì—ëŸ¬:', e);
          }
        }

        renderFines();
        hideModal('fineRuleModal');
        showToast('ë²Œê¸ˆ ê·œì¹™ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
      }

      // ========== MEETINGS ==========
      function renderMeetings() {
        const el = document.getElementById('meetingList');
        el.innerHTML = DEMO_MEETINGS.map(m => `
    <div class="meeting-card" style="${m.status === 'done' ? 'border-left-color:#aaa;opacity:0.7;' : ''}">
      <div class="meeting-title">${m.title}</div>
      <div class="meeting-meta">${m.date} ${m.time} Â· ${m.status === 'done' ? 'ì™„ë£Œ' : 'ì˜ˆì •'}</div>
      <div class="meeting-meta" style="margin-top:4px;">${m.agenda.split('\n')[0]}</div>
      <div class="meeting-actions">
        <button class="btn btn-outline btn-sm" onclick="viewMeeting(${m.id})">ìƒì„¸ë³´ê¸°</button>
        ${m.status !== 'done' ? `<button class="btn btn-sm btn-success" onclick="completeMeeting(${m.id})">ì™„ë£Œ</button>` : ''}
      </div>
    </div>
  `).join('');

        // Populate assignee dropdown
        const sel = document.getElementById('actionItemAssignee');
        if (sel) {
          sel.innerHTML = DEMO_MEMBERS.map(m => `<option value="${m.nickname}">${m.nickname}</option>`).join('');
        }
      }

      function viewMeeting(id) {
        selectedMeetingId = id;
        const m = DEMO_MEETINGS.find(x => x.id === id);
        if (!m) return;

        document.getElementById('meetingDetailCard').style.display = 'block';
        document.getElementById('meetingDetailTitle').textContent = 'ğŸ“‹ ' + m.title;
        document.getElementById('meetingMinutes').value = m.minutes || '';

        // Comments
        document.getElementById('meetingComments').innerHTML = m.comments.length === 0
          ? '<p style="font-size:12px;color:var(--text-sub);padding:8px 0;">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</p>'
          : m.comments.map(c => `
      <div class="comment-item">
        <div class="comment-avatar">${renderEmoticonImg(c.emoticon, 28)}</div>
        <div class="comment-body">
          <div class="comment-author">${c.user}</div>
          <div class="comment-text">${c.text}</div>
          <div class="comment-time">${c.time}</div>
        </div>
      </div>
    `).join('');

        // Action Items
        renderActionItems(m);

        // Scroll to detail
        document.getElementById('meetingDetailCard').scrollIntoView({ behavior: 'smooth' });
      }

      function renderActionItems(m) {
        document.getElementById('actionItemsList').innerHTML = m.actionItems.map((a, i) => `
    <div class="action-item ${a.done ? 'done' : ''}">
      <input type="checkbox" ${a.done ? 'checked' : ''} onchange="toggleActionItem(${m.id}, ${i})">
      <span style="flex:1;">${a.text}</span>
      <span style="font-size:11px;color:var(--text-sub);">${a.assignee}</span>
    </div>
  `).join('');
      }

      async function addComment() {
        const m = DEMO_MEETINGS.find(x => x.id === selectedMeetingId);
        if (!m) return;
        const text = document.getElementById('commentInput').value.trim();
        if (!text) return;
        m.comments.push({
          user: currentUser?.nickname || 'ì•„ë¹ ',
          emoticon: currentUser?.emoticon || './imo/1.png',
          text,
          time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
        });
        document.getElementById('commentInput').value = '';
        viewMeeting(m.id);
        showToast('ëŒ“ê¸€ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');

        // Supabase ì—…ë°ì´íŠ¸ (commentsëŠ” ë¡œì»¬ ì „ìš©ìœ¼ë¡œ ì²˜ë¦¬ - DBì— comments ì»¬ëŸ¼ì´ ì—†ì„ ìˆ˜ ìˆìŒ)
      }

      async function addActionItem() {
        const m = DEMO_MEETINGS.find(x => x.id === selectedMeetingId);
        if (!m) return;
        const text = document.getElementById('actionItemInput').value.trim();
        if (!text) return;
        const assignee = document.getElementById('actionItemAssignee').value;
        m.actionItems.push({ text, assignee, done: false });
        document.getElementById('actionItemInput').value = '';
        renderActionItems(m);
        showToast('ì•¡ì…˜ ì•„ì´í…œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');

        // Supabase ì—…ë°ì´íŠ¸
        if (sbClient && currentFamily?.id) {
          try {
            const { error } = await sbClient.from('meetings')
              .update({ action_items: JSON.stringify(m.actionItems) })
              .eq('id', selectedMeetingId);
            if (error) console.error('ì•¡ì…˜ ì•„ì´í…œ ì €ì¥ ì‹¤íŒ¨:', error);
          } catch (e) {
            console.error('ì•¡ì…˜ ì•„ì´í…œ ì €ì¥ ì—ëŸ¬:', e);
          }
        }
      }

      async function toggleActionItem(meetingId, idx) {
        const m = DEMO_MEETINGS.find(x => x.id === meetingId);
        if (m) {
          m.actionItems[idx].done = !m.actionItems[idx].done;
          renderActionItems(m);

          // Supabase ì—…ë°ì´íŠ¸
          if (sbClient && currentFamily?.id) {
            try {
              const { error } = await sbClient.from('meetings')
                .update({ action_items: JSON.stringify(m.actionItems) })
                .eq('id', meetingId);
              if (error) console.error('ì•¡ì…˜ ì•„ì´í…œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            } catch (e) {
              console.error('ì•¡ì…˜ ì•„ì´í…œ ì—…ë°ì´íŠ¸ ì—ëŸ¬:', e);
            }
          }
        }
      }

      async function saveMeetingMinutes() {
        const m = DEMO_MEETINGS.find(x => x.id === selectedMeetingId);
        if (m) {
          m.minutes = document.getElementById('meetingMinutes').value;
          showToast('íšŒì˜ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');

          // Supabase ì—…ë°ì´íŠ¸
          if (sbClient && currentFamily?.id) {
            try {
              const { error } = await sbClient.from('meetings')
                .update({ minutes: m.minutes })
                .eq('id', selectedMeetingId);
              if (error) console.error('íšŒì˜ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
            } catch (e) {
              console.error('íšŒì˜ë¡ ì €ì¥ ì—ëŸ¬:', e);
            }
          }
        }
      }

      async function completeMeeting(id) {
        const m = DEMO_MEETINGS.find(x => x.id === id);
        if (m) {
          m.status = 'done';
          renderMeetings();
          showToast('íšŒì˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');

          // Supabase ì—…ë°ì´íŠ¸
          if (sbClient && currentFamily?.id) {
            try {
              const { error } = await sbClient.from('meetings')
                .update({ status: 'done' })
                .eq('id', id);
              if (error) console.error('íšŒì˜ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            } catch (e) {
              console.error('íšŒì˜ ìƒíƒœ ì—…ë°ì´íŠ¸ ì—ëŸ¬:', e);
            }
          }
        }
      }

      async function addMeeting() {
        const title = document.getElementById('meetingTitle').value.trim();
        if (!title) return showToast('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
        const date = document.getElementById('meetingDate').value || new Date().toISOString().slice(0, 10);
        const time = document.getElementById('meetingTime').value || '20:00';
        const agenda = document.getElementById('meetingAgenda').value;

        const meetingId = crypto.randomUUID();
        DEMO_MEETINGS.unshift({
          id: meetingId, title, date, time, agenda, status: 'upcoming',
          comments: [], minutes: '', actionItems: []
        });

        // Supabaseì— ì €ì¥
        if (sbClient && currentFamily?.id) {
          try {
            const { error } = await sbClient.from('meetings').insert({
              id: meetingId,
              family_id: currentFamily.id,
              title: title,
              meeting_date: date,
              meeting_time: time,
              agenda: agenda,
              status: 'upcoming',
              minutes: '',
              created_by: currentUser?.nickname || null
            });
            if (error) {
              console.error('íšŒì˜ ì €ì¥ ì‹¤íŒ¨:', error);
              appendOutput('íšŒì˜ ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            } else {
              appendOutput('íšŒì˜ Supabase ì €ì¥ ì™„ë£Œ');
            }
          } catch (e) {
            console.error('íšŒì˜ ì €ì¥ ì—ëŸ¬:', e);
          }
        }

        renderMeetings();
        hideModal('meetingModal');
        showToast('íšŒì˜ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');

        // Also add to calendar
        const day = new Date(date).getDate();
        if (!DEMO_EVENTS[day]) DEMO_EVENTS[day] = [];
        DEMO_EVENTS[day].push({ title: 'ğŸ“‹ ' + title, time, scope: 'family' });
        renderCalendar();
      }

      // ========== VOTES ==========
      function renderVotes() {
        const active = DEMO_VOTES.filter(v => v.status === 'active');
        const closed = DEMO_VOTES.filter(v => v.status === 'closed');

        document.getElementById('activeVotesList').innerHTML = active.length === 0
          ? '<p style="font-size:13px;color:var(--text-sub);text-align:center;padding:12px;">ì§„í–‰ ì¤‘ì¸ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤</p>'
          : active.map(v => renderVoteCard(v)).join('');

        document.getElementById('closedVotesList').innerHTML = closed.length === 0
          ? '<p style="font-size:13px;color:var(--text-sub);text-align:center;padding:12px;">ì™„ë£Œëœ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤</p>'
          : closed.map(v => renderVoteCard(v)).join('');
      }

      function renderVoteCard(v) {
        const totalVotes = v.options.reduce((s, o) => s + o.votes.length, 0);
        const myName = currentUser?.nickname || 'ì•„ë¹ ';
        const myVoted = v.options.some(o => o.votes.includes(myName));
        const deadline = new Date(v.deadline);
        const isExpired = deadline < new Date();
        const showResults = myVoted || v.status === 'closed' || isExpired;

        let html = `<div style="background:var(--bg);border-radius:12px;padding:14px;margin-bottom:10px;">`;
        html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">`;
        html += `<div style="font-weight:700;font-size:14px;">${v.title}</div>`;
        html += `<span class="badge ${v.status === 'active' && !isExpired ? 'badge-pending' : 'badge-done'}">${v.status === 'active' && !isExpired ? 'ì§„í–‰ ì¤‘' : 'ë§ˆê°'}</span>`;
        html += `</div>`;
        html += `<div style="font-size:11px;color:var(--text-sub);margin-bottom:10px;">ë§ˆê°: ${deadline.toLocaleString('ko-KR')} Â· ${v.anonymous === true ? 'ìµëª…' : 'ê³µê°œ'} Â· ${v.multiple ? 'ë³µìˆ˜ì„ íƒ' : 'ë‹¨ì¼ì„ íƒ'} Â· ì°¸ì—¬ ${totalVotes}ëª…</div>`;

        v.options.forEach((o, i) => {
          const pct = totalVotes > 0 ? Math.round(o.votes.length / totalVotes * 100) : 0;
          const isMyVote = o.votes.includes(myName);
          html += `<div class="vote-option ${isMyVote ? 'voted' : ''}" onclick="castVote(${v.id}, ${i})">`;
          html += `<span style="font-size:13px;min-width:100px;">${o.text}</span>`;
          if (showResults) {
            html += `<div class="vote-bar-bg"><div class="vote-bar-fill" style="width:${pct}%"></div></div>`;
            html += `<span class="vote-pct">${pct}%</span>`;
          }
          html += `</div>`;
        });

        if (showResults && !v.anonymous) {
          html += `<div style="margin-top:8px;font-size:11px;color:var(--text-sub);">`;
          v.options.forEach(o => {
            if (o.votes.length > 0) html += `${o.text}: ${o.votes.join(', ')}<br>`;
          });
          html += `</div>`;
        }

        html += `</div>`;
        return html;
      }

      async function castVote(voteId, optIdx) {
        const v = DEMO_VOTES.find(x => x.id === voteId);
        if (!v || v.status === 'closed') return;
        if (new Date(v.deadline) < new Date()) return showToast('íˆ¬í‘œê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤');

        const myName = currentUser?.nickname || 'ì•„ë¹ ';

        if (!v.multiple) {
          // Remove existing vote
          v.options.forEach(o => {
            o.votes = o.votes.filter(n => n !== myName);
          });
        }

        const opt = v.options[optIdx];
        if (opt.votes.includes(myName)) {
          opt.votes = opt.votes.filter(n => n !== myName);
        } else {
          opt.votes.push(myName);
        }

        renderVotes();
        showToast('íˆ¬í‘œê°€ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤');

        // Supabase ì—…ë°ì´íŠ¸
        if (sbClient && currentFamily?.id) {
          try {
            const { error } = await sbClient.from('votes')
              .update({ options: JSON.stringify(v.options) })
              .eq('id', voteId);
            if (error) console.error('íˆ¬í‘œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
          } catch (e) {
            console.error('íˆ¬í‘œ ì—…ë°ì´íŠ¸ ì—ëŸ¬:', e);
          }
        }
      }

      function addVoteOptionInput() {
        const container = document.getElementById('voteOptionsContainer');
        const count = container.children.length + 1;
        const div = document.createElement('div');
        div.style.cssText = 'display:flex;gap:6px;margin-bottom:6px;';
        div.innerHTML = `<input type="text" class="vote-option-input" placeholder="ì„ íƒì§€ ${count}" style="flex:1;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;">`;
        container.appendChild(div);
      }

      async function createVote() {
        const title = document.getElementById('voteTitle').value.trim();
        if (!title) return showToast('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');

        const inputs = document.querySelectorAll('.vote-option-input');
        const options = Array.from(inputs).map(i => i.value.trim()).filter(Boolean);
        if (options.length < 2) return showToast('ìµœì†Œ 2ê°œ ì„ íƒì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”');

        const deadline = document.getElementById('voteDeadline').value || new Date(Date.now() + 86400000).toISOString().slice(0, 16);
        const anonymous = document.getElementById('voteAnonymous').value === 'true';
        const multiple = document.getElementById('voteMultiple').value === 'true';

        const voteId = crypto.randomUUID();
        const voteOptions = options.map(t => ({ text: t, votes: [] }));

        DEMO_VOTES.unshift({
          id: voteId, title, anonymous, multiple, deadline, status: 'active',
          options: voteOptions
        });

        // Supabaseì— ì €ì¥
        if (sbClient && currentFamily?.id) {
          try {
            const { error } = await sbClient.from('votes').insert({
              id: voteId,
              family_id: currentFamily.id,
              title: title,
              is_anonymous: anonymous,
              is_multiple: multiple,
              deadline: new Date(deadline).toISOString(),
              status: 'active',
              options: JSON.stringify(voteOptions),
              created_by: currentUser?.nickname || null
            });
            if (error) {
              console.error('íˆ¬í‘œ ì €ì¥ ì‹¤íŒ¨:', error);
              appendOutput('íˆ¬í‘œ ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            } else {
              appendOutput('íˆ¬í‘œ Supabase ì €ì¥ ì™„ë£Œ');
            }
          } catch (e) {
            console.error('íˆ¬í‘œ ì €ì¥ ì—ëŸ¬:', e);
          }
        }

        renderVotes();
        hideModal('voteModal');
        showToast('íˆ¬í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
      }

      // ========== STATS & WEIGHTED ROULETTE ==========
      function renderStats() {
        // Completion chart per member
        const memberStats = {};
        DEMO_MEMBERS.forEach(m => memberStats[m.nickname] = { total: 0, done: 0 });
        // Simulate data
        Object.values(DEMO_WEEKLY_SCHEDULE).forEach(day => {
          Object.values(day).forEach(name => {
            if (memberStats[name]) {
              memberStats[name].total++;
              if (Math.random() > 0.22) memberStats[name].done++;
            }
          });
        });

        const totalAll = Object.values(memberStats).reduce((s, m) => s + m.total, 0);
        const doneAll = Object.values(memberStats).reduce((s, m) => s + m.done, 0);
        document.getElementById('statCompletionRate').textContent = totalAll > 0 ? Math.round(doneAll / totalAll * 100) + '%' : '0%';
        document.getElementById('statTotalAssigned').textContent = totalAll;

        document.getElementById('completionChart').innerHTML = Object.entries(memberStats).map(([name, s]) => {
          const pct = s.total > 0 ? Math.round(s.done / s.total * 100) : 0;
          return `<div class="bar-col">
      <div class="bar-value">${pct}%</div>
      <div class="bar" style="height:${pct}px;background:${pct >= 80 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--danger)'}"></div>
      <div class="bar-label">${name}</div>
    </div>`;
        }).join('');

        // Weekly table
        const chores = ['ì„¤ê±°ì§€', 'ì²­ì†Œ', 'ìš”ë¦¬'];
        const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
        let tableHtml = '<thead><tr><th style="padding:6px;border-bottom:2px solid var(--border);font-size:11px;"></th>';
        days.forEach(d => tableHtml += `<th style="padding:6px;border-bottom:2px solid var(--border);font-size:11px;">${d}</th>`);
        tableHtml += '</tr></thead><tbody>';
        chores.forEach(c => {
          tableHtml += `<tr><td style="padding:6px;font-weight:600;font-size:11px;">${c}</td>`;
          days.forEach(d => {
            const name = DEMO_WEEKLY_SCHEDULE[d]?.[c] || '-';
            const emoji = DEMO_MEMBERS.find(m => m.nickname === name)?.emoticon || '';
            tableHtml += `<td style="padding:6px;text-align:center;font-size:11px;">${renderEmoticonImg(emoji, 20)}<br>${name}</td>`;
          });
          tableHtml += '</tr>';
        });
        tableHtml += '</tbody>';
        document.getElementById('weeklyTable').innerHTML = tableHtml;

        // Fine trend
        const weeks = ['1ì£¼ì°¨', '2ì£¼ì°¨', '3ì£¼ì°¨', '4ì£¼ì°¨'];
        const fineAmounts = [3000, 5000, 2000, 4000];
        const maxF = Math.max(...fineAmounts);
        document.getElementById('fineTrendChart').innerHTML = weeks.map((w, i) => `
    <div class="bar-col">
      <div class="bar-value">${(fineAmounts[i] / 1000).toFixed(0)}k</div>
      <div class="bar" style="height:${(fineAmounts[i] / maxF) * 90}px;background:${fineAmounts[i] > 3000 ? 'var(--danger)' : 'var(--primary)'}"></div>
      <div class="bar-label">${w}</div>
    </div>
  `).join('');

        // Weight settings
        document.getElementById('weightSettings').innerHTML = DEMO_MEMBERS.map(m => `
    <div class="weight-row">
      <span class="member-name">${renderEmoticonImg(m.emoticon, 20)} ${m.nickname}</span>
      <input type="range" min="1" max="10" value="5" class="weight-slider" data-member="${m.nickname}" oninput="this.nextElementSibling.textContent=this.value">
      <span class="weight-val">5</span>
    </div>
  `).join('');
      }

      function spinWeightedRoulette() {
        const sliders = document.querySelectorAll('.weight-slider');
        const pool = [];
        sliders.forEach(s => {
          const weight = parseInt(s.value);
          for (let i = 0; i < weight; i++) pool.push(s.dataset.member);
        });
        if (pool.length === 0) return;
        const winner = pool[Math.floor(Math.random() * pool.length)];
        const emoji = DEMO_MEMBERS.find(m => m.nickname === winner)?.emoticon || '';
        document.getElementById('weightedRouletteResult').innerHTML =
          `ğŸ‰ <span style="color:var(--primary)">${renderEmoticonImg(emoji, 24)} ${winner}</span> ë‹¹ì²¨!`;
        showToast('ê°€ì¤‘ì¹˜ ë£°ë › ê²°ê³¼: ' + winner);
      }

      // ========== SUPABASE ==========
      async function connectSupabase() {
        const statusEl = document.getElementById('connStatus');
        const textEl = document.getElementById('connText');
        const btn = document.querySelector('button[onclick="connectSupabase()"]');

        const url = document.getElementById('supabaseUrl').value.trim();
        const key = document.getElementById('supabaseKey').value.trim();
        if (!url || !key) {
          statusEl.className = 'conn-status conn-fail';
          textEl.textContent = 'ë¯¸ì„¤ì •';
          appendOutput('Supabase URLê³¼ Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
          return;
        }

        // If config changed, reset client
        if (sbClient && (sbConfig.url !== url || sbConfig.key !== key)) {
          appendOutput('ì„¤ì • ë³€ê²½ ê°ì§€, í´ë¼ì´ì–¸íŠ¸ ì¬ìƒì„±...', 'info');
          sbClient = null;
          sbConfig = null;
        }

        // Return existing client if already connected
        if (sbClient && sbConfig) {
          statusEl.className = 'conn-status conn-ok';
          textEl.textContent = 'ì—°ê²°ë¨';
          appendOutput('ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤', 'info');
          return sbClient;
        }

        // Prevent concurrent connections
        if (sbConnecting) {
          appendOutput('ì—°ê²° ì‹œë„ ì¤‘...', 'info');
          return sbConnecting;
        }

        if (btn) btn.disabled = true;

        // Supabase CDN ë™ì  ë¡œë“œ
        if (!window.supabase || !window.supabase.createClient) {
          appendOutput('Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘...', 'info');
          try {
            await new Promise(function (resolve, reject) {
              var s = document.createElement('script');
              s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
              s.onload = resolve;
              s.onerror = reject;
              document.head.appendChild(s);
            });
            appendOutput('Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ', 'info');
          } catch (e) {
            statusEl.className = 'conn-status conn-fail';
            textEl.textContent = 'ì˜¤í”„ë¼ì¸';
            appendOutput('Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨ (ì¸í„°ë„· ì—°ê²° í™•ì¸)', 'error');
            if (btn) btn.disabled = false;
            return;
          }
        }

        if (!window.supabase || !window.supabase.createClient) {
          statusEl.className = 'conn-status conn-fail';
          textEl.textContent = 'ì˜¤í”„ë¼ì¸';
          appendOutput('Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
          if (btn) btn.disabled = false;
          return;
        }

        statusEl.className = 'conn-status conn-loading';
        textEl.textContent = 'ì—°ê²° ì¤‘';

        sbConnecting = (async function () {
          try {
            appendOutput('Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì¤‘...', 'info');

            // Create client with unique storage key to prevent multiple instances
            const storageKey = 'fh-proto-' + Date.now();
            sbClient = window.supabase.createClient(url, key, {
              auth: {
                persistSession: false,
                autoRefreshToken: false,
                detectSessionInUrl: false,
                storageKey: storageKey
              }
            });

            sbConfig = { url: url, key: key };

            // Test connection with health check
            const response = await fetch(url + '/rest/v1/', {
              headers: { 'apikey': key, 'Authorization': 'Bearer ' + key }
            });

            statusEl.className = 'conn-status conn-ok';
            textEl.textContent = 'ì—°ê²°ë¨';
            appendOutput('âœ… Supabase ì—°ê²° ì„±ê³µ!', 'info');

            return sbClient;
          } catch (e) {
            statusEl.className = 'conn-status conn-fail';
            textEl.textContent = 'ì‹¤íŒ¨';

            var errMsg = (e && e.message) ? e.message : JSON.stringify(e);

            if (e && e.code === 'PGRST301') {
              errMsg = 'RLS ì •ì±… ì˜¤ë¥˜: í…Œì´ë¸” ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. Supabase ëŒ€ì‹œë³´ë“œì—ì„œ RLS ì •ì±…ì„ í™•ì¸í•˜ì„¸ìš”.';
            } else if (e && (e.status === 401 || e.code === '401')) {
              errMsg = 'ì¸ì¦ ì‹¤íŒ¨: Anon Keyê°€ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ RLS ì •ì±…ì´ ìµëª… ì ‘ê·¼ì„ ì°¨ë‹¨í•˜ê³  ìˆìŠµë‹ˆë‹¤.';
            } else if (e && (e.status === 403 || e.code === '403')) {
              errMsg = 'ì ‘ê·¼ ê±°ë¶€: RLS ì •ì±…ì—ì„œ ìµëª… ì‚¬ìš©ìì˜ ì ‘ê·¼ì„ ì°¨ë‹¨í•˜ê³  ìˆìŠµë‹ˆë‹¤.';
            } else if (e && e.message && e.message.includes('Failed to fetch')) {
              errMsg = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: Supabase URLì„ í™•ì¸í•˜ê±°ë‚˜ ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.';
            }

            appendOutput('âŒ Supabase ì—°ê²° ì‹¤íŒ¨: ' + errMsg, 'error');
            console.error('Supabase ì—°ê²° ì‹¤íŒ¨', e);

            sbClient = null;
            sbConfig = null;

            return null;
          } finally {
            sbConnecting = null;
            if (btn) btn.disabled = false;
          }
        })();

        return sbConnecting;
      }

      // í…Œì´ë¸”ë³„ í‘œì‹œí•  ì»¬ëŸ¼ ë° í•œê¸€ ë¼ë²¨ ì •ì˜
      const TABLE_DISPLAY_CONFIG = {
        families: {
          columns: ['family_name', 'family_code', 'created_at'],
          labels: { family_name: 'ê°€ì¡±ëª…', family_code: 'ì½”ë“œ', created_at: 'ìƒì„±ì¼' }
        },
        users: {
          columns: ['nickname', 'login_id', 'role', 'emoticon'],
          labels: { nickname: 'ë‹‰ë„¤ì„', login_id: 'ì•„ì´ë””', role: 'ì—­í• ', emoticon: 'ì´ëª¨í‹°ì½˜' }
        },
        emoticons: {
          columns: ['user_id', 'emoticon', 'sent_at'],
          labels: { user_id: 'ë³´ë‚¸ì´', emoticon: 'ì´ëª¨í‹°ì½˜', sent_at: 'ì‹œê°„' }
        },
        events: {
          columns: ['title', 'scope', 'start_at'],
          labels: { title: 'ì œëª©', scope: 'ë²”ìœ„', start_at: 'ì‹œì‘ì¼' }
        },
        chores: {
          columns: ['title', 'assigned_to', 'due_date', 'is_done'],
          labels: { title: 'ì§‘ì•ˆì¼', assigned_to: 'ë‹´ë‹¹ì', due_date: 'ê¸°í•œ', is_done: 'ì™„ë£Œ' }
        },
        fines: {
          columns: ['rule_name', 'amount', 'user_id', 'created_at'],
          labels: { rule_name: 'ê·œì¹™', amount: 'ê¸ˆì•¡', user_id: 'ëŒ€ìƒ', created_at: 'ìƒì„±ì¼' }
        },
        roulette_results: {
          columns: ['chore_id', 'winner_user_id', 'created_at'],
          labels: { chore_id: 'ì§‘ì•ˆì¼', winner_user_id: 'ë‹¹ì²¨ì', created_at: 'ë‚ ì§œ' }
        }
      };

      // ë°ì´í„°ë¥¼ í‘œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      function formatAsTable(data, table) {
        if (!data || data.length === 0) {
          return '<div style="color:var(--text-secondary);padding:8px;">ë°ì´í„° ì—†ìŒ</div>';
        }

        const config = TABLE_DISPLAY_CONFIG[table] || {};
        const columns = config.columns || Object.keys(data[0]).slice(0, 5);
        const labels = config.labels || {};

        let html = '<table style="width:100%;border-collapse:collapse;font-size:11px;margin:8px 0;">';

        // í—¤ë”
        html += '<thead><tr style="background:rgba(139,92,246,0.3);">';
        columns.forEach(col => {
          const label = labels[col] || col;
          html += `<th style="padding:6px 8px;text-align:left;border-bottom:1px solid var(--border-color);">${label}</th>`;
        });
        html += '</tr></thead>';

        // ë°”ë””
        html += '<tbody>';
        data.forEach((row, idx) => {
          const bgColor = idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.05)';
          html += `<tr style="background:${bgColor};">`;
          columns.forEach(col => {
            let val = row[col];
            // ê°’ í¬ë§·íŒ…
            if (val === null || val === undefined) val = '-';
            else if (typeof val === 'boolean') val = val ? 'âœ“' : 'âœ—';
            else if (col.includes('_at') || col.includes('date')) {
              val = new Date(val).toLocaleDateString('ko-KR');
            } else if (typeof val === 'object') val = JSON.stringify(val).slice(0, 20) + '...';
            else if (typeof val === 'string' && val.length > 15) val = val.slice(0, 15) + '...';
            html += `<td style="padding:6px 8px;border-bottom:1px solid var(--border-color);color:var(--text-primary);">${val}</td>`;
          });
          html += '</tr>';
        });
        html += '</tbody></table>';

        return html;
      }

      async function testAPI(table) {
        if (!sbClient) return appendOutput('Supabaseì— ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”', 'error');
        clearOutput();
        appendOutput(`ğŸ“Š ${table.toUpperCase()} í…Œì´ë¸” ì¡°íšŒ`, 'info');
        try {
          const { data, error } = await sbClient.from(table).select('*').limit(10);
          if (error) throw error;
          appendOutput(`ì´ ${data.length}ê±´`, 'success');
          appendOutputHTML(formatAsTable(data, table));
        } catch (e) {
          appendOutput('ì—ëŸ¬: ' + e.message, 'error');
        }
      }

      async function runCustomQuery() {
        if (!sbClient) return appendOutput('Supabaseì— ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”', 'error');
        const table = document.getElementById('customTable').value.trim();
        const select = document.getElementById('customSelect').value.trim() || '*';
        const limit = parseInt(document.getElementById('customLimit').value) || 10;

        if (!table) return appendOutput('í…Œì´ë¸”ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');

        clearOutput();
        appendOutput(`ğŸ“Š ì»¤ìŠ¤í…€ ì¿¼ë¦¬: ${table}`, 'info');
        try {
          const { data, error } = await sbClient.from(table).select(select).limit(limit);
          if (error) throw error;
          appendOutput(`ì´ ${data.length}ê±´ (ìµœëŒ€ ${limit}ê±´)`, 'success');
          appendOutputHTML(formatAsTable(data, table));
        } catch (e) {
          appendOutput('ì—ëŸ¬: ' + e.message, 'error');
        }
      }

      function clearOutput() {
        const el = document.getElementById('apiOutput');
        if (el) el.innerHTML = '';
      }

      function appendOutput(msg, type) {
        const el = document.getElementById('apiOutput');
        if (!el) return;
        const span = document.createElement('div');
        span.style.padding = '4px 0';
        if (type === 'info') span.style.color = '#60a5fa';
        else if (type === 'error') span.style.color = '#f87171';
        else if (type === 'success') span.style.color = '#4ade80';
        span.textContent = msg;
        el.appendChild(span);
        el.scrollTop = el.scrollHeight;
      }

      function appendOutputHTML(html) {
        const el = document.getElementById('apiOutput');
        if (!el) return;
        const div = document.createElement('div');
        div.innerHTML = html;
        el.appendChild(div);
        el.scrollTop = el.scrollHeight;
      }

      // ========== ADMIN AUTHENTICATION ==========
      function toggleAdminLogin() {
        if (isAdminLoggedIn) {
          adminLogout();
        } else {
          showModal('adminLoginModal');
          // Clear previous inputs and errors
          document.getElementById('adminUsername').value = '';
          document.getElementById('adminPassword').value = '';
          document.getElementById('adminLoginError').style.display = 'none';
        }
      }

      function adminLogin(event) {
        event.preventDefault();

        const username = document.getElementById('adminUsername').value;
        const password = document.getElementById('adminPassword').value;
        const errorEl = document.getElementById('adminLoginError');

        // Check credentials
        if (username === 'admin' && password === 'family4u') {
          isAdminLoggedIn = true;
          hideModal('adminLoginModal');
          updateAdminUI();
          showToast('âœ… ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ!');
        } else {
          errorEl.textContent = 'âŒ ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          errorEl.style.display = 'block';
        }
      }

      function adminLogout() {
        isAdminLoggedIn = false;
        updateAdminUI();
        showToast('ğŸ”“ ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
      }

      function updateAdminUI() {
        const testPanels = document.getElementById('adminTestPanels');
        const loginBtn = document.getElementById('adminLoginBtn');

        if (!testPanels || !loginBtn) {
          console.warn('Admin UI elements not found');
          return;
        }

        if (isAdminLoggedIn) {
          testPanels.style.setProperty('display', 'block', 'important');
          loginBtn.innerHTML = 'ğŸ”“ ë¡œê·¸ì•„ì›ƒ';
        } else {
          testPanels.style.setProperty('display', 'none', 'important');
          loginBtn.innerHTML = 'ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸';
        }
      }

      // ========== INIT ==========
      document.addEventListener('DOMContentLoaded', async function () {
        try {
          var ed = document.getElementById('eventDate');
          if (ed) ed.valueAsDate = new Date();
          var md = document.getElementById('meetingDate');
          if (md) md.valueAsDate = new Date();

          // Initialize admin UI state
          updateAdminUI();

          // ìë™ìœ¼ë¡œ Supabase ì—°ê²°
          await autoConnectSupabase();

          // ì €ì¥ëœ ë¡œê·¸ì¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
          loadSavedLogin();

          // ì´ˆëŒ€ ë§í¬ í™•ì¸
          checkInviteLink();
        } catch (e) { console.error('Init error', e); }
        console.log('Family Hub í”„ë¡œí† íƒ€ì… ë¡œë“œ ì™„ë£Œ');
      });

      // ì•± ì‹œì‘ ì‹œ ìë™ Supabase ì—°ê²°
      async function autoConnectSupabase() {
        const statusEl = document.getElementById('connStatus');
        const textEl = document.getElementById('connText');

        // í•˜ë“œì½”ë”©ëœ Supabase ì„¤ì •
        const url = 'https://qvforisbxbapojpafbma.supabase.co';
        const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2Zm9yaXNieGJhcG9qcGFmYm1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDM0NjgsImV4cCI6MjA4NTg3OTQ2OH0.LSfAT1NqD2Y5p1Wp_vG6I_KZ9mY2jrTCjrfyajvpIrk';

        try {
          // Supabase CDN ë™ì  ë¡œë“œ
          if (!window.supabase || !window.supabase.createClient) {
            console.log('Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘...');
            await new Promise(function (resolve, reject) {
              var s = document.createElement('script');
              s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
              s.onload = resolve;
              s.onerror = reject;
              document.head.appendChild(s);
            });
          }

          // í´ë¼ì´ì–¸íŠ¸ ìƒì„±
          sbClient = window.supabase.createClient(url, key);
          sbConfig = { url, key };

          // ì—°ê²° í…ŒìŠ¤íŠ¸ - RPC ping ë˜ëŠ” ê°„ë‹¨í•œ ì¿¼ë¦¬
          try {
            // ë¨¼ì € ê°„ë‹¨í•œ health check ì‹œë„
            const response = await fetch(url + '/rest/v1/', {
              headers: { 'apikey': key, 'Authorization': 'Bearer ' + key }
            });
            if (!response.ok && response.status !== 404) throw new Error('API ì—°ê²° ì‹¤íŒ¨');
          } catch (testErr) {
            console.warn('Health check ì‹¤íŒ¨, ê³„ì† ì§„í–‰:', testErr.message);
          }

          // ì—°ê²° ì„±ê³µ
          if (statusEl) statusEl.className = 'conn-status conn-ok';
          if (textEl) textEl.textContent = 'ì—°ê²°ë¨';
          console.log('âœ… Supabase ìë™ ì—°ê²° ì„±ê³µ');
        } catch (e) {
          console.error('âŒ Supabase ìë™ ì—°ê²° ì‹¤íŒ¨:', e.message);
          if (statusEl) statusEl.className = 'conn-status conn-fail';
          if (textEl) textEl.textContent = 'ì—°ê²° ì‹¤íŒ¨';
        }
      }

      // ========== ì „ì—­ í•¨ìˆ˜ ë“±ë¡ (onclickì—ì„œ í˜¸ì¶œ) ==========
      window.showAuthTab = showAuthTab;
      window.loginUser = loginUser;
      window.checkFamilyName = checkFamilyName;
      window.resetFamilyNameCheck = resetFamilyNameCheck;
      window.checkUserId = checkUserId;
      window.resetUserIdCheck = resetUserIdCheck;
      window.createFamily = createFamily;
      window.joinFamily = joinFamily;
      window.quickLogin = quickLogin;
      window.logout = logout;
      window.showPage = showPage;
      window.showModal = showModal;
      window.hideModal = hideModal;
      window.changeMonth = changeMonth;
      window.selectDate = selectDate;
      window.addEvent = addEvent;
      window.addChore = addChore;
      window.addFamilyMember = addFamilyMember;
      window.showMemberEmoticonPicker = showMemberEmoticonPicker;
      window.selectMemberEmoticon = selectMemberEmoticon;
      window.showInviteLink = showInviteLink;
      window.copyInviteLink = copyInviteLink;
      window.addFineRule = addFineRule;
      window.spinRoulette = spinRoulette;
      window.selectEmoticon = selectEmoticon;
      window.pickEmoticon = pickEmoticon;
      window.connectSupabase = connectSupabase;
      window.testAPI = testAPI;
      window.runCustomQuery = runCustomQuery;
      window.addVoteOptionInput = addVoteOptionInput;
      window.createVote = createVote;
      window.castVote = castVote;
      window.addMeeting = addMeeting;
      window.viewMeeting = viewMeeting;
      window.completeMeeting = completeMeeting;
      window.addComment = addComment;
      window.addActionItem = addActionItem;
      window.toggleActionItem = toggleActionItem;
      window.saveMeetingMinutes = saveMeetingMinutes;
      window.spinWeightedRoulette = spinWeightedRoulette;
      window.exportToGoogleCalendar = exportToGoogleCalendar;
      window.exportAllToGoogleCalendar = exportAllToGoogleCalendar;
      window.importFromGoogle = importFromGoogle;
      window.importGoogleDemo = importGoogleDemo;
      window.toggleAdminLogin = toggleAdminLogin;
      window.adminLogin = adminLogin;
      window.adminLogout = adminLogout;

      // ========== RECURRENCE TOGGLE ==========
      document.addEventListener('DOMContentLoaded', function () {
        var recSel = document.getElementById('eventRecurrence');
        if (recSel) {
          recSel.addEventListener('change', function () {
            document.getElementById('recurrenceEndGroup').style.display = this.value !== 'none' ? 'block' : 'none';
          });
        }

        // Check for Google OAuth redirect token
        var hash = window.location.hash;
        if (hash && hash.includes('access_token')) {
          var params = new URLSearchParams(hash.substring(1));
          gcalToken = params.get('access_token');
          window.location.hash = '';
          showGcalConnected();
        }
      });

    })(); // IIFE ì¢…ë£Œ
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('ServiceWorker registered:', registration.scope);
          })
          .catch(error => {
            console.log('ServiceWorker registration failed:', error);
          });
      });
    }

    // PWA Install Prompt Handler
    let deferredPrompt;
    const installBanner = document.getElementById('installBanner');

    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent Chrome 67+ from automatically showing the prompt
      e.preventDefault();
      // Stash the event so it can be triggered later
      deferredPrompt = e;
      // Show install banner
      if (!localStorage.getItem('pwaInstallDismissed')) {
        installBanner.style.display = 'block';
      }
    });

    function installPWA() {
      if (deferredPrompt) {
        // Hide banner
        installBanner.style.display = 'none';
        // Show browser install prompt
        deferredPrompt.prompt();
        // Wait for user response
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('User accepted PWA install');
            showToast('ğŸ‰ ì•±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!');
          } else {
            console.log('User dismissed PWA install');
          }
          deferredPrompt = null;
        });
      } else {
        // For iOS or browsers without beforeinstallprompt
        showIOSInstallGuide();
      }
    }

    function dismissInstall() {
      installBanner.style.display = 'none';
      localStorage.setItem('pwaInstallDismissed', 'true');
    }

    function showIOSInstallGuide() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      showModal('installGuideModal');
      // ê¸°ê¸°ì— ë”°ë¼ ìë™ ì„ íƒ
      if (isIOS) {
        showInstallGuide('ios');
      } else {
        showInstallGuide('android');
      }
    }

    function showInstallGuide(device) {
      const iosGuide = document.getElementById('iosGuide');
      const androidGuide = document.getElementById('androidGuide');
      const iosBtn = document.getElementById('iosTabBtn');
      const androidBtn = document.getElementById('androidTabBtn');

      if (device === 'ios') {
        iosGuide.style.display = 'block';
        androidGuide.style.display = 'none';
        iosBtn.style.background = 'var(--accent-blue)';
        iosBtn.style.color = 'white';
        androidBtn.style.background = 'var(--bg-tertiary)';
        androidBtn.style.color = 'var(--text-main)';
      } else {
        iosGuide.style.display = 'none';
        androidGuide.style.display = 'block';
        androidBtn.style.background = 'var(--accent-green)';
        androidBtn.style.color = 'white';
        iosBtn.style.background = 'var(--bg-tertiary)';
        iosBtn.style.color = 'var(--text-main)';
      }
    }

    // Detect if app is installed
    window.addEventListener('appinstalled', () => {
      console.log('PWA was installed');
      installBanner.style.display = 'none';
      deferredPrompt = null;
    });

    // Check if running as standalone (already installed)
    if (window.matchMedia('(display-mode: standalone)').matches) {
      console.log('Running as installed PWA');
    }
  </script>
</body>

</html>